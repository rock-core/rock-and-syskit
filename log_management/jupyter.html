<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Building Robots with Rock and Syskit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>

    <body class="log_management log_management_jupyter">
            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" role="complementary">
                <nav class="docs-sidebar" data-spy="affix">
                    <ul class="nav"><li class='child'><a href="../">Building robots with Rock and Syskit</a></li><li class='parent'><span class='parent-label'><a href="../basics/">Basics</a></span><ul><li class='child'><a href="../basics/">Introduction</a></li><li class='child'><a href="../basics/installation.html">Installation</a></li><li class='child'><a href="../basics/day_to_day.html">Day-to-day Workspace Commands</a></li><li class='child'><a href="../basics/getting_started.html">Getting Started</a></li><li class='child'><a href="../basics/composition.html">Compositions</a></li><li class='child'><a href="../basics/constant_generator.html">Constant Generator</a></li><li class='child'><a href="../basics/devices.html">Profiles and Devices</a></li><li class='child'><a href="../basics/deployment.html">Deployment</a></li><li class='child'><a href="../basics/publishing.html">Publishing</a></li><li class='child'><a href="../basics/validation.html">Configuration Consistency</a></li><li class='child'><a href="../basics/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../runtime_overview/">Runtime Overview</a></span><ul><li class='child'><a href="../runtime_overview/">Introduction</a></li><li class='child'><a href="../runtime_overview/task_structure.html">Task Structures</a></li><li class='child'><a href="../runtime_overview/event_loop.html">Event Loop</a></li><li class='child'><a href="../runtime_overview/exceptions.html">Errors</a></li><li class='child'><a href="../runtime_overview/live_data.html">Live Data Visualization</a></li><li class='child'><a href="../runtime_overview/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../workspace/">Workspace and Packages</a></span><ul><li class='child'><a href="../workspace/">Introduction</a></li><li class='child'><a href="../workspace/conventions.html">Conventions</a></li><li class='child'><a href="../workspace/setup.html">Starting a New Project</a></li><li class='child'><a href="../workspace/add_packages.html">Adding new packages</a></li><li class='child'><a href="../workspace/os_dependencies.html">OS Dependencies</a></li><li class='child'><a href="../workspace/global_configuration.html">Global Configuration</a></li><li class='child'><a href="../workspace/testing.html">Test Integration</a></li><li class='child'><a href="../workspace/managing.html">Build configuration design</a></li><li class='child'><a href="../workspace/troubleshooting.html">Troubleshooting</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../libraries/">Libraries</a></span><ul><li class='child'><a href="../libraries/">Introduction</a></li><li class='child'><a href="../libraries/add_packages.html">Add packages</a></li><li class='child'><a href="../libraries/cpp_libraries.html">C++ Library Packages</a></li><li class='child'><a href="../libraries/geometric_transformations.html">Geometric Transformations in C++ Libraries</a></li><li class='child'><a href="../libraries/ruby_libraries.html">Ruby Library Packages</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../components/">Components</a></span><ul><li class='child'><a href="../components/">Writing Components</a></li><li class='child'><a href="../components/orogen_packages.html">oroGen Packages</a></li><li class='child'><a href="../components/defining_types.html">Defining Types</a></li><li class='child'><a href="../components/importing_types.html">Importing Types</a></li><li class='child'><a href="../components/interface.html">Interface</a></li><li class='child'><a href="../components/state_machine.html">State Machine</a></li><li class='child'><a href="../components/writing_the_hooks.html">Writing the Hooks</a></li><li class='child'><a href="../components/timestamping.html">Timestamping</a></li><li class='child'><a href="../components/stream_aligner.html">Stream Aligner</a></li><li class='child'><a href="../components/geometric_transformations.html">Geometric Transformations</a></li><li class='child'><a href="../components/deployment.html">Deployments</a></li><li class='child'><a href="../components/runtime.html">Runtime</a></li><li class='child'><a href="../components/testing.html">Testing</a></li><li class='child'><a href="../components/types_in_ruby.html">Types in Ruby</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../component_networks/">Designing Component Networks</a></span><ul><li class='child'><a href="../component_networks/">Introduction</a></li><li class='child'><a href="../component_networks/composition.html">Compositions</a></li><li class='child'><a href="../component_networks/profiles.html">Profiles</a></li><li class='child'><a href="../component_networks/reusable_networks.html">Reusable Networks</a></li><li class='child'><a href="../component_networks/devices_and_busses.html">Robot definition&colon; Devices and Busses</a></li><li class='child'><a href="../component_networks/dynamic_services.html">Dynamic Services</a></li><li class='child'><a href="../component_networks/geometric_transformations.html">Geometric Transformations</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../coordination/">Coordination</a></span><ul><li class='child'><a href="../coordination/">Introduction</a></li><li class='child'><a href="../coordination/generalities.html">Generalities</a></li><li class='child'><a href="../coordination/tasks_and_events.html">Tasks and Events</a></li><li class='child'><a href="../coordination/action_methods.html">Action Methods</a></li><li class='child'><a href="../coordination/action_state_machines.html">Action State Machines</a></li><li class='child'><a href="../coordination/component_networks.html">Component Networks</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../simulation/">Simulation with Gazebo</a></span><ul><li class='child'><a href="../simulation/">Introduction</a></li><li class='child'><a href="../simulation/models_links_and_joints.html">Models, Links, Joints and Sensors</a></li><li class='child'><a href="../simulation/plugins.html">Plugins</a></li><li class='child'><a href="../simulation/transformer.html">Transformer</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_error_handling/">Error Handling</a></span><ul><li class='child'><a href="../syskit_error_handling/">Introduction</a></li></ul></li><li class='parent active'><span class='parent-label'><a href="./">Log Management</a></span><ul><li class='child'><a href="./">Introduction</a></li><li class='child'><a href="runtime.html">Log Generation at Runtime</a></li><li class='child'><a href="datastore.html">Storing Logs</a></li><li class='child active'><a href="jupyter.html">Log Analysis with Jupyter</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../testing/">Testing and Debugging</a></span><ul><li class='child'><a href="../testing/">Introduction</a></li><li class='child'><a href="../testing/component.html">Component Tests</a></li><li class='child'><a href="../testing/integration.html">Integration Tests</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../cookbook/">Cookbook</a></span><ul><li class='child'><a href="../cookbook/">Introduction</a></li><li class='child'><a href="../cookbook/device_drivers.html">Device Drivers with iodrivers_base</a></li><li class='child'><a href="../cookbook/http_api.html">Control and Monitoring through a HTTP API</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../deprecations/">Deprecated Behaviors</a></span><ul><li class='child'><a href="../deprecations/">Introduction</a></li><li class='child'><a href="../deprecations/backward_compatible_naming.html">Backward compatible naming</a></li><li class='child'><a href="../deprecations/update_properties.html">Introduction of the `update_properties` method</a></li></ul></li></ul>
                </nav>
            </div>
            <div class="col-md-9" role="main">
                <h1 class="no_toc" id="log-analysis-using-jupyter">Log Analysis using Jupyter</h1>

<ul id="markdown-toc">
  <li><a href="#preamble" id="markdown-toc-preamble">Preamble</a></li>
  <li><a href="#transforming-log-streams-into-data-frames" id="markdown-toc-transforming-log-streams-into-data-frames">Transforming log streams into data frames</a>    <ul>
      <li><a href="#for-a-single-stream" id="markdown-toc-for-a-single-stream">For a single stream</a></li>
      <li><a href="#for-multiple-streams" id="markdown-toc-for-multiple-streams">For multiple streams</a></li>
      <li><a href="#dealing-with-missing-data" id="markdown-toc-dealing-with-missing-data">Dealing with missing data</a></li>
      <li><a href="#subsampling" id="markdown-toc-subsampling">Subsampling</a></li>
    </ul>
  </li>
  <li><a href="#using-syskit-data" id="markdown-toc-using-syskit-data">Using Syskit data</a></li>
  <li><a href="#plotting-using-vega" id="markdown-toc-plotting-using-vega">Plotting using Vega</a></li>
  <li><a href="#annotating-plots-with-syskit-task-data" id="markdown-toc-annotating-plots-with-syskit-task-data">Annotating plots with Syskit task data</a></li>
  <li><a href="#limitations" id="markdown-toc-limitations">Limitations</a></li>
</ul>

<p>The <a href="https://github.com/rock-core/rock.jupyter-package_set">rock.jupyter</a>
generates a Jupyter configuration to have a Ruby kernel matching the version
from the package set. To add it to your workspace, add the package set in the
<code>package_sets</code> section of your <code>autoproj/manifest</code>, the <code>rock.jupyter.osdeps</code>
metapackage to the manifest itself.</p>

<div class="highlight"><pre class="highlight yaml"><code><span class="na">package_sets</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">...</span>
<span class="pi">-</span> <span class="na">github</span><span class="pi">:</span> <span class="s">rock-core/rock.jupyter-package_set</span>

<span class="na">manifest</span><span class="pi">:</span>
<span class="pi">-</span> <span class="s">...</span>
<span class="pi">-</span> <span class="s">rock.jupyter.osdeps</span>
</code></pre></div>
<p>and run <code>autoproj osdeps</code></p>

<p>To start using Jupyter within your Rock workspace, either start
<code>jupyter-notebook</code> after having loaded the workspace's env.sh, or start it with
<code>autoproj exec</code>, e.g.</p>

<div class="highlight"><pre class="highlight plaintext"><code>.autoproj/bin/autoproj exec jupyter-notebook
</code></pre></div>
<p>At this point, you may create a notebook that uses a Ruby kernel. If you have set
the <code>SYSKIT_LOG_DATASTORE</code> <a href="datastore.html">environment variable</a>, this kernel
will use that datastore by default.</p>

<p>TODO: screencast</p>

<p>This support is aimed at relatively simple plotting and analysis. If your goal
is to perform very advanced processing (such as e.g. machine learning), we
recommend to use functionality described in this guide to extract the data you
need, but then export it into something other languages with bigger data
analysis ecosystems (e.g.  Python, R, …) can load. Everything that is being
done here can be done in a single Ruby script.</p>

<p>The general workflow is:</p>

<ul>
  <li>select a dataset</li>
  <li>restrict the processing time interval and/or specify a subsampling</li>
  <li>convert the streams of interest into a <a href="https://github.com/sciruby/daru">daru</a>
dataframe</li>
  <li>plot/analyze the extracted data or save it for further analysis in other languages</li>
</ul>

<p>In addition, the DSL supports using Syskit event data to find sections of the
dataset that are of interest. This is a very powerful mean to provide context to the
raw data, as Syskit tasks/compositions, in the end, describe the system's intents.</p>

<h2 id="preamble">Preamble</h2>

<p>Add the following in the first cell of the notebook, to load the notebook support:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="nb">require</span> <span class="s2">"syskit/log"</span>
<span class="nb">require</span> <span class="s2">"syskit/log/dsl"</span>
<span class="kp">extend</span> <span class="no">Syskit</span><span class="o">::</span><span class="no">Log</span><span class="o">::</span><span class="no">DSL</span>
</code></pre></div>
<p><code>Syskit::Log::DSL</code> is designed to ease analysis of a single dataset. Load the
dataset by its ID with the following statement. We <strong>strongly</strong> recommend that
this statement is the last of a cell, as it will display details about the
dataset, such as the list of tasks, ports and properties it contains.</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">dataset_select</span> <span class="s2">"SOME_DATASET_ID"</span>
</code></pre></div>
<p>After this statement, all other statements will use that dataset.</p>

<h2 id="transforming-log-streams-into-data-frames">Transforming log streams into data frames</h2>

<h3 id="for-a-single-stream">For a single stream</h3>

<p>The <code>to_daru_frame</code> statement is a one-stop command to convert many log streams
into a single data frame, aligning the data using the log streams' timestamps.
We will first see how it works for a single stream, and go on with multiple
streams just afterwards.</p>

<p>Within the DSL, reference to ports are of the form
<code>task_name_task.port_name_port</code> when passed as argument to <code>to_daru_frame</code>. For
instance, assuming we had a pose estimator task called <code>pose_estimator</code> in the
system, with a <code>pose_samples</code> port, one would do the following to create a frame
from it.</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">frame</span> <span class="o">=</span> <span class="n">to_daru_frame</span> <span class="n">pose_estimator_task</span><span class="p">.</span><span class="nf">pose_samples_port</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
    <span class="o">...</span>
<span class="k">end</span>
</code></pre></div>
<p>The list of tasks and ports is displayed by <code>dataset_select</code> when it is last in
a cell.</p>

<p>The <code>p</code> object yield above by <code>to_daru_frame</code> represents a sample generated by
the port, and allows to create columns in the generated dataframe, based on
fields in the data type. The data type is the typelib type (i.e. C++ type or
intermediate type in a case of opaques), <strong>not</strong> the associated ruby type. See
<a href="../components/types_in_ruby.html">this page</a></p>

<p>In our example, assuming the pose is a RigidBodyState, to get the X, Y and Z coordinates of the position:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">frame</span> <span class="o">=</span> <span class="n">to_daru_frame</span> <span class="n">pose_estimator_task</span><span class="p">.</span><span class="nf">pose_samples_port</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"x"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">position</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">}</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">position</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">}</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"z"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">position</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p><code>RigidBodyState</code> being derived from opaque types, the data structure we are
manipulating here is the one showed as "Logging type" on the type page in
the Syskit IDE:</p>

<p><img src="screenshot_logging_type.png" alt="Logging type for RigidBodyState" /></p>

<p>Alternatively, within the Jupyter notebook, one can use <code>summarize</code> to get
details about a port's data type:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">summarize</span> <span class="n">pose_estimator_task</span><span class="p">.</span><span class="nf">pose_samples_port</span>
</code></pre></div>
<p><img src="screenshot_summarize_port.png" alt="Summarize output port" /></p>

<p>If you want to use some methods from the Ruby type that is used to represent a
Rock type, you may use the transform method. For instance, to create a column
containing a RigidBodyState heading, do</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">frame</span> <span class="o">=</span> <span class="n">to_daru_frame</span> <span class="n">pose_estimator_task</span><span class="p">.</span><span class="nf">pose_samples_port</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"yaw"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">orientation</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:yaw</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p><code>RididBodyState.orientation</code> is converted first to its Ruby equivalent
(<code>Eigen::Quaternion</code>) for which Rock defines a <code>yaw</code> method. Note that you should
do this only if it is not possible to perform the data on the column afterwards.
If you wanted to scale a column from radians to degress (for plotting later), it
is significantly faster to compute the scaling afterwards:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">frame</span> <span class="o">=</span> <span class="n">to_daru_frame</span> <span class="n">trajectory_controller_task</span><span class="p">.</span><span class="nf">heading_command_port</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
    <span class="nb">p</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"target_angle"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">angle</span><span class="p">.</span><span class="nf">rad</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>frame["target_angle"] = frame["target_angle"] * 180 / Math::PI
~~~</p>

<p>Daru, the underlying dataframe handling library supports most basic numerical
computations on columns, as well as some more useful sliding-window operations
such as mean/stdev, …</p>

<h3 id="for-multiple-streams">For multiple streams</h3>

<p>When given more than one port, <code>to_daru_frame</code> will align them all to the first
port. In practice, it means that it generates new lines in the frame whenever
there is a new sample for the first port, and fills the rest of the columns with
the last sample of the other streams it found just before. The selection of the
first port is therefore, rather obviously, critical.</p>

<p>Right now, alignment is done with the log stream's logical time, which is the
time when the sample was received by the logger.</p>

<p>For instance:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">df</span> <span class="o">=</span> <span class="n">to_daru_frame</span> <span class="p">\</span>
    <span class="n">trajectory_controller_task</span><span class="p">.</span><span class="nf">heading_command_port</span><span class="p">,</span> <span class="p">\</span>
    <span class="n">pose_estimator_task</span><span class="p">.</span><span class="nf">pose_samples_port</span> <span class="k">do</span> <span class="o">|</span><span class="n">cmd</span><span class="p">,</span> <span class="n">pose</span><span class="o">|</span>

    <span class="n">cmd</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"cmd_heading"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">orientation</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:yaw</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">pose</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"x"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">position</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">pose</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">position</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<h3 id="dealing-with-missing-data">Dealing with missing data</h3>

<p>By default, when aligning multiple streams, <code>to_daru_frame</code> will always use the
last received sample for any given stream, regardless of how old it is. The optional
<code>timeout</code> parameter allows to "reset" this value after a time (in seconds) and use
the column's no-data value (which is nil for categorical data and NAN for numerical
data)</p>

<p>Let's assume for instance that the pose stream we have used in the above examples
have a straing 10Hz period, without skip. However, the heading command has "holes"
whenever the heading controller was not in use (for instance). The following definition
will make sure that the <code>cmd_heading</code> column is filled with NaNs whenever this was
the case:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">df</span> <span class="o">=</span> <span class="n">to_daru_frame</span> <span class="p">\</span>
    <span class="n">pose_estimator_task</span><span class="p">.</span><span class="nf">pose_samples_port</span><span class="p">,</span>
    <span class="n">trajectory_controller_task</span><span class="p">.</span><span class="nf">heading_command_port</span><span class="p">,</span> <span class="ss">timeout: </span><span class="mi">1</span> <span class="k">do</span> <span class="o">|</span><span class="n">pose</span><span class="p">,</span> <span class="n">cmd</span><span class="o">|</span>
    <span class="n">pose</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"x"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">position</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">pose</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">position</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">cmd</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">"cmd_heading"</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">s</span><span class="p">.</span><span class="nf">orientation</span><span class="p">.</span><span class="nf">transform</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:yaw</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div>
<p>Note that the alignment happens on the first stream given as parameter. If we were
to change the order of the ports in the call to <code>to_daru_frame</code>, the sections without
data in that stream would instead not appear at all.</p>

<h3 id="subsampling">Subsampling</h3>

<p>To do rough analysis or plotting of long datasets, the analysis DSL allows to
configure subsampling parameter using the <code>interval_sample_every</code> statement. It
can be given in number of samples (e.g. <code>interval_sample_every samples: 10</code>) or
time between samples (e.g. <code>interval_sample_every seconds: 0.2</code>).</p>

<p>One thing to consider when aligning streams is that subsampling happens to
streams independently (before alignment)</p>

<h2 id="using-syskit-data">Using Syskit data</h2>

<p>Syskit execution data is also available within the notebooks, to provide context.
This allows to find where things are in the timeline, a critical aspect when one
has to deal with hours or even days of data in a single dataset.</p>

<p>The simplest form is to list instances of a given task (task context, ruby task
context, composition) model using <code>summarize</code>.</p>

<p>Given an orogen model <code>aceinna_imu::Task</code>, one does</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">summarize</span> <span class="n">roby</span><span class="o">.</span><span class="no">OroGen</span><span class="p">.</span><span class="nf">imu_aceinna_openimu</span><span class="o">.</span><span class="no">Task</span>
</code></pre></div>
<p>which lists the instances of that particular task. It works for task contexts as well
as compositions and ruby tasks.</p>

<p><img src="screenshot_summarize_task.png" alt="openimu instances" /></p>

<p>Then, to restrict further processing to the interval of an instance of that
particular task, one does</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">interval_select</span> <span class="n">roby</span><span class="o">.</span><span class="no">OroGen</span><span class="p">.</span><span class="nf">imu_aceinna_openimu</span><span class="o">.</span><span class="no">Task</span><span class="p">.</span><span class="nf">by_id</span><span class="p">(</span><span class="mi">767</span><span class="p">)</span>
</code></pre></div>
<p>Alternatively, particular events might be of more interest, for instance</p>

<div class="highlight"><pre class="highlight plaintext"><code>summarize roby.OroGen.imu_aceinna_openimu.Task.exception_event
</code></pre></div>
<p>Gives</p>

<p><img src="screenshot_summarize_event_emissions.png" alt="openimu exception event emission" /></p>

<p>which can then used to restrict the processing interval.</p>

<h2 id="plotting-using-vega">Plotting using Vega</h2>

<p>The <code>syskit-log</code> Jupyter helpers have functionality geared towards plotting using
vega-lite (through a thin Ruby wrapper).</p>

<p>The simplest helper, <code>vega_simple_plot</code>, does a X/Y plot based on a Daru frame, e.g.</p>

<div class="highlight"><pre class="highlight plaintext"><code>vega_simple_plot(df, x: "t", y: "velocity")
</code></pre></div>
<p>Under the scenes, daru and vega have very different data representations. The dataframe
is first converted in an array of hashes and then plotted. If multiple plot are to be
made based on the same data, it is best to convert them first with <code>daru_to_vega</code>:</p>

<div class="highlight"><pre class="highlight plaintext"><code>df_vega = daru_to_vega(df)
vega_simple_plot(df_vega, x: "t", y: "velocity")
</code></pre></div>
<p>Layering simple plots can be done with</p>

<div class="highlight"><pre class="highlight plaintext"><code>Vega.lite.data(df_vega).layer([
    vega_simple_view(x: "t", y: "velocity"),
    vega_simple_view(x: "t", y: "x_velocity"),
])
</code></pre></div>
<p><code>layer</code> can be replaced by <code>vconcat</code> to have plots vertically stacked and <code>hconcat</code>
to have them horizontally aligned.</p>

<p>Generally speaking, the vega-rb layer maps the vega-lite specification in a rather
straightforward way. Use <a href="https://vega.github.io/vega-lite/">Vega Lite's documentation</a>
as a reference.</p>

<p>For reference, <code>vega_simple_plot</code> and <code>vega_simple_view</code> are roughly equivalent to</p>

<div class="highlight"><pre class="highlight plaintext"><code>Vega.lite.encoding(x: { field: "t", type: "quantitative" },v
                   y: { field: "velocity", type: "quantitative" })
         .mark(type: "line").width(800)
</code></pre></div>
<h2 id="annotating-plots-with-syskit-task-data">Annotating plots with Syskit task data</h2>

<p>The <code>ruby_vega_mark_tasks</code> call is a very powerful way to tag vega data with the
ID and name of a Syskit task. This would allow to e.g. change the color or style based on
the system's currently selected behavior.</p>

<p>For instance, let's assume we have a <code>df</code> dataframe converted into a <code>df_vega</code> Vega data
array, and we want to visualize with of the tasks contained in a <code>current_missions</code> array
is currently active. One would do:</p>

<div class="highlight"><pre class="highlight plaintext"><code>roby_vega_mark_tasks("current_mission", df_vega, *current_missions, time_field: "t")
</code></pre></div>
<p>The call will add a "current_mission" field in each sample with a string that describes
the task running at the time of the sample (contained in field "t"). Then the following:</p>

<div class="highlight"><pre class="highlight plaintext"><code>vega_simple_plot(x: "t", y: "rudder_angle", color: nil)
    .encoding(color: { field: "current_mission" })
</code></pre></div>
<p>would create a X/Y plot with the color of the line determined by the current task. The
task list is displayed in the legend. For instance:</p>

<p><img src="screenshot_jupyter_roby_vega_mark_tasks.png" alt="color-coded current task" /></p>

<p>The <code>roby_task_timeline</code> also allows to simply plot a timeline of the given tasks
(as a horizontal bar graph).</p>

<h2 id="limitations">Limitations</h2>

<ul>
  <li>all processing to data frames is done in the sample's logical time (time when it
reached the logger) instead of the sample's own time. The long term objective is
to write the latter into the former during normalization.</li>
</ul>

            </div>
        </div>
    </div>

    <script>
    $('.docs-sidebar').affix({
        offset: {
            top: $('.docs-sidebar').offset().top
        }
    });
    </script>


        <footer class="container-fluid text-center">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Building Robots with Rock and Syskit</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/doudou" property="cc:attributionName" rel="cc:attributionURL">Sylvain Joyeux</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. Copyright Sylvain Joyeux and Contributors
        </footer>
    </body>
</html>
