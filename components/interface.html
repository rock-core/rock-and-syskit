<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Building Robots with Rock and Syskit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>

    <body class="components components_interface">
            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" role="complementary">
                <nav class="docs-sidebar" data-spy="affix">
                    <ul class="nav"><li class='child'><a href="../">Building robots with Rock and Syskit</a></li><li class='parent'><span class='parent-label'><a href="../basics/">Basics</a></span><ul><li class='child'><a href="../basics/">Introduction</a></li><li class='child'><a href="../basics/installation.html">Installation</a></li><li class='child'><a href="../basics/day_to_day.html">Day-to-day Workspace Commands</a></li><li class='child'><a href="../basics/getting_started.html">Getting Started</a></li><li class='child'><a href="../basics/composition.html">Compositions</a></li><li class='child'><a href="../basics/constant_generator.html">Constant Generator</a></li><li class='child'><a href="../basics/devices.html">Profiles and Devices</a></li><li class='child'><a href="../basics/deployment.html">Deployment</a></li><li class='child'><a href="../basics/publishing.html">Publishing</a></li><li class='child'><a href="../basics/validation.html">Configuration Consistency</a></li><li class='child'><a href="../basics/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../runtime_overview/">Runtime Overview</a></span><ul><li class='child'><a href="../runtime_overview/">Introduction</a></li><li class='child'><a href="../runtime_overview/task_structure.html">Task Structures</a></li><li class='child'><a href="../runtime_overview/event_loop.html">Event Loop</a></li><li class='child'><a href="../runtime_overview/exceptions.html">Errors</a></li><li class='child'><a href="../runtime_overview/live_data.html">Live Data Visualization</a></li><li class='child'><a href="../runtime_overview/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../workspace/">Workspace and Packages</a></span><ul><li class='child'><a href="../workspace/">Introduction</a></li><li class='child'><a href="../workspace/conventions.html">Conventions</a></li><li class='child'><a href="../workspace/setup.html">Starting a New Project</a></li><li class='child'><a href="../workspace/add_packages.html">Adding new packages</a></li><li class='child'><a href="../workspace/os_dependencies.html">OS Dependencies</a></li><li class='child'><a href="../workspace/global_configuration.html">Global Configuration</a></li><li class='child'><a href="../workspace/testing.html">Test Integration</a></li><li class='child'><a href="../workspace/managing.html">Build configuration design</a></li><li class='child'><a href="../workspace/troubleshooting.html">Troubleshooting</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../libraries/">Libraries</a></span><ul><li class='child'><a href="../libraries/">Introduction</a></li><li class='child'><a href="../libraries/add_packages.html">Add packages</a></li><li class='child'><a href="../libraries/cpp_libraries.html">C++ Library Packages</a></li><li class='child'><a href="../libraries/geometric_transformations.html">Geometric Transformations in C++ Libraries</a></li><li class='child'><a href="../libraries/ruby_libraries.html">Ruby Library Packages</a></li></ul></li><li class='parent active'><span class='parent-label'><a href="./">Components</a></span><ul><li class='child'><a href="./">Writing Components</a></li><li class='child'><a href="orogen_packages.html">oroGen Packages</a></li><li class='child'><a href="defining_types.html">Defining Types</a></li><li class='child'><a href="importing_types.html">Importing Types</a></li><li class='child active'><a href="interface.html">Interface</a></li><li class='child'><a href="state_machine.html">State Machine</a></li><li class='child'><a href="writing_the_hooks.html">Writing the Hooks</a></li><li class='child'><a href="timestamping.html">Timestamping</a></li><li class='child'><a href="stream_aligner.html">Stream Aligner</a></li><li class='child'><a href="geometric_transformations.html">Geometric Transformations</a></li><li class='child'><a href="deployment.html">Deployments</a></li><li class='child'><a href="runtime.html">Runtime</a></li><li class='child'><a href="testing.html">Testing</a></li><li class='child'><a href="types_in_ruby.html">Types in Ruby</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../component_networks/">Designing Component Networks</a></span><ul><li class='child'><a href="../component_networks/">Introduction</a></li><li class='child'><a href="../component_networks/composition.html">Compositions</a></li><li class='child'><a href="../component_networks/profiles.html">Profiles</a></li><li class='child'><a href="../component_networks/reusable_networks.html">Reusable Networks</a></li><li class='child'><a href="../component_networks/devices_and_busses.html">Robot definition&colon; Devices and Busses</a></li><li class='child'><a href="../component_networks/dynamic_services.html">Dynamic Services</a></li><li class='child'><a href="../component_networks/geometric_transformations.html">Geometric Transformations</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../coordination/">Coordination</a></span><ul><li class='child'><a href="../coordination/">Introduction</a></li><li class='child'><a href="../coordination/generalities.html">Generalities</a></li><li class='child'><a href="../coordination/tasks_and_events.html">Tasks and Events</a></li><li class='child'><a href="../coordination/action_methods.html">Action Methods</a></li><li class='child'><a href="../coordination/action_state_machines.html">Action State Machines</a></li><li class='child'><a href="../coordination/component_networks.html">Component Networks</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../simulation/">Simulation with Gazebo</a></span><ul><li class='child'><a href="../simulation/">Introduction</a></li><li class='child'><a href="../simulation/models_links_and_joints.html">Models, Links, Joints and Sensors</a></li><li class='child'><a href="../simulation/plugins.html">Plugins</a></li><li class='child'><a href="../simulation/transformer.html">Transformer</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_error_handling/">Error Handling</a></span><ul><li class='child'><a href="../syskit_error_handling/">Introduction</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../log_management/">Log Management</a></span><ul><li class='child'><a href="../log_management/">Introduction</a></li><li class='child'><a href="../log_management/runtime.html">Log Generation at Runtime</a></li><li class='child'><a href="../log_management/datastore.html">Storing Logs</a></li><li class='child'><a href="../log_management/jupyter.html">Log Analysis with Jupyter</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../testing/">Testing and Debugging</a></span><ul><li class='child'><a href="../testing/">Introduction</a></li><li class='child'><a href="../testing/component.html">Component Tests</a></li><li class='child'><a href="../testing/integration.html">Integration Tests</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../cookbook/">Cookbook</a></span><ul><li class='child'><a href="../cookbook/">Introduction</a></li><li class='child'><a href="../cookbook/device_drivers.html">Device Drivers with iodrivers_base</a></li><li class='child'><a href="../cookbook/http_api.html">Control and Monitoring through a HTTP API</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../deprecations/">Deprecated Behaviors</a></span><ul><li class='child'><a href="../deprecations/">Introduction</a></li><li class='child'><a href="../deprecations/backward_compatible_naming.html">Backward compatible naming</a></li><li class='child'><a href="../deprecations/update_properties.html">Introduction of the `update_properties` method</a></li></ul></li></ul>
                </nav>
            </div>
            <div class="col-md-9" role="main">
                <h1 class="no_toc" id="component-interfaces">Component Interfaces</h1>

<ul id="markdown-toc">
  <li><a href="#interface-elements" id="markdown-toc-interface-elements">Interface Elements</a>    <ul>
      <li><a href="#ports" id="markdown-toc-ports">Ports</a></li>
      <li><a href="#properties" id="markdown-toc-properties">Properties</a></li>
      <li><a href="#dynamic-properties" id="markdown-toc-dynamic-properties">Dynamic Properties</a></li>
      <li><a href="#operations" id="markdown-toc-operations">Operations</a></li>
      <li><a href="#dynamic_ports" id="markdown-toc-dynamic_ports">Dynamic Ports</a></li>
    </ul>
  </li>
  <li><a href="#inheritance" id="markdown-toc-inheritance">Inheritance</a></li>
</ul>

<p>We'll cover in this page how to define your task's interface. All statements
presented in this page are to be included in a component definition, i.e.
between 'do' and 'end' in</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="c1"># Documentation of the task context</span>
<span class="n">task_context</span> <span class="s2">"ClassName"</span> <span class="k">do</span>
   <span class="n">needs_configuration</span>

   <span class="o">...</span>
<span class="k">end</span>
</code></pre></div>
<p>The only constraint on <code>ClassName</code> is that it <em>must</em> be different from the
project name. How one is meant to interact with these elements in the task's
own code is dealt with <a href="writing_the_hooks.html">later</a></p>

<p>The <code>needs_configuration</code> statement is historical and should always be present.</p>

<h2 id="interface-elements">Interface Elements</h2>

<p class="fullwidth"><img src="media/orocos_component.svg" alt="RTT Component Interface" /></p>

<ul>
  <li><strong>Ports</strong> are used to transfer data between the components</li>
  <li><strong>Properties</strong> are used to store and set configuration parameters</li>
  <li>Finally, <strong>Operations</strong> (not represented here) are used to do remote method
calls on the components</li>
</ul>

<p>As a general rule of thumb, the components should communicate with each other
only through ports. The properties and operations (as well as the state machine
covered in <a href="state_machine.html">the next page</a>) are meant to be used by
a coordination layer, namely Syskit in our case.</p>

<p>Documentation for an interface element should be written as a comment directly
on top of the declaration.</p>

<h3 id="ports">Ports</h3>

<p>Ports are defined with</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="c1"># A documentation string</span>
<span class="n">input_port</span> <span class="s1">'in'</span><span class="p">,</span> <span class="s1">'my_type'</span>
<span class="c1"># Another documentation string</span>
<span class="n">output_port</span> <span class="s1">'out'</span><span class="p">,</span> <span class="s1">'another_type'</span>
</code></pre></div>
<h3 id="properties">Properties</h3>

<p>Properties are defined with</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="c1"># What this property is about</span>
<span class="n">property</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"configuration_type"</span>
</code></pre></div>
<p>Plain properties <strong>must</strong> be read by the component only before it is started. If
one needs to be able to change the value at runtime, the property must be
declared <code>dynamic</code> (see next section)</p>

<p>Properties using simple types (booleans, ints, enums, …) can have a default
value specified directly in the orogen file:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="c1"># If true, the image is halved</span>
<span class="n">property</span> <span class="s2">"downscale_2x"</span><span class="p">,</span> <span class="s2">"/bool"</span><span class="p">,</span> <span class="kp">false</span>
</code></pre></div>
<p>For more complex types, the initialization should be done in the task's constructors, e.g.</p>

<div class="highlight"><pre class="highlight cpp"><code><span class="n">Task</span><span class="o">::</span><span class="n">Task</span><span class="p">(...)</span> <span class="p">{</span>
    <span class="n">_initial_position</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3</span><span class="p">.</span><span class="n">Zero</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="dynamic-properties">Dynamic Properties</h3>

<p>Plain properties can't be changed at runtime. They must be set before the
component is configured. To be allowed to change a property at runtime,
declare it as dynamic in the orogen file:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="c1"># What this property is about</span>
<span class="n">property</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="s2">"configuration_type"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">dynamic</span>
</code></pre></div>
<p class="important"><strong>Don't make everything dynamic</strong>. Use dynamic properties only for things that
(1) won't cause unacceptable latency in the component's processing and
(2) for which the "dynamicity" is easy to implement. A counter example is for
instance a device whose change in parameter would take a few seconds. This
should definitely <em>not</em> be dynamic. A good example would be a simple scaling
parameter, which is only injected in a numerical equation - that is something
that won't require any internal reinitialization.</p>

<p>By default, a dynamic property will simply be updated in a thread-safe way,
so that the component's runtime hooks (e.g. <code>updateHook</code>) can read it safely.
This is fine for simple properties, whose value can be read and applied at each
execution cycle.</p>

<p>For more complex changes, that e.g. require the reconfiguration of the underlying
library (or of the underlying device), it is possible to redefine an automatically
generated virtual method which will be called on update. The method is always named
<code>set${property_name_with_first_letter_uppercase}</code>. As always with orogen, in doubt,
just have a look into the <code>templates/tasks/</code> folder (once code generation ran after
the addition of the <code>dynamic</code> attribute). The task template will contain a default
implementation of this method, for instance:</p>

<div class="highlight"><pre class="highlight cpp"><code><span class="kt">bool</span> <span class="n">PIDTask</span><span class="o">::</span><span class="n">setSettings</span><span class="p">(</span><span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ActuatorSettings</span><span class="o">&gt;</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">motor_controller</span><span class="o">::</span><span class="n">PIDTaskBase</span><span class="o">::</span><span class="n">setSettings</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>This default method just calls the default implementation, which will actually update
the value of the property (here <code>_settings</code>) and return true to indicate the update
was accepted.</p>

<p>When reimplementing this method, make sure that:</p>

<ul>
  <li>it returns true if the change was accepted, and that the property object was
updated accordingly (just call the base method for that)</li>
  <li>it returns false if the new value is not acceptable</li>
  <li>it is error-safe, that is the underlying code should continue to behave
as-if the value was not changed if an error occurs and the method returns
false</li>
</ul>

<p class="important"><strong>This last point</strong> (error-safety) is in itself a good reason to avoid dynamic
properties. Error safety can be rather hard to get right. You've been warned.</p>

<p>The <code>set</code> callbacks are <strong>not</strong> automatically called in <code>configureHook</code>, only
when the component is running. If you want to call them, for instance because
they do some validatio on the values, you may call the <code>updateDynamicProperties()</code>
method which will, and return true if all setters have returned true, or false otherwise.</p>

<h3 id="operations">Operations</h3>

<p>The operations offer a mechanism from which a task context can expose
functionality through remote method calls. They are defined with:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="c1"># Documentation of the operation</span>
<span class="n">operation</span><span class="p">(</span><span class="s1">'commandName'</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">argument</span><span class="p">(</span><span class="s1">'arg0'</span><span class="p">,</span> <span class="s1">'/arg/type'</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">argument</span><span class="p">(</span><span class="s1">'arg1'</span><span class="p">,</span> <span class="s1">'/example/other_arg'</span><span class="p">)</span>
</code></pre></div>
<p>Additionally, a return type can be added with</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="c1"># Documentation of the operation</span>
<span class="n">operation</span><span class="p">(</span><span class="s1">'operationName'</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">returns</span><span class="p">(</span><span class="s1">'int'</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">argument</span><span class="p">(</span><span class="s1">'arg0'</span><span class="p">,</span> <span class="s1">'/arg/type'</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">argument</span><span class="p">(</span><span class="s1">'arg1'</span><span class="p">,</span> <span class="s1">'/example/other_arg'</span><span class="p">)</span>
</code></pre></div>
<p>Note the dot at the beginning of all the additional operation definition
statements. This dot is important and, if omitted, will lead to syntax
errors. If no return type is provided, the operation returns nothing.</p>

<p class="important"><strong>When to use an operation ?</strong> Well, don't. Mostly. Operations should very
rarely be used, as they create hard synchronization between components. The one
common case where an operation is actually useful is if something <em>really
expensive</em> needs to rarely be done in the middle of the component processing,
such as dumping an internal state that is really expensive to dump.</p>

<h3 id="dynamic_ports">Dynamic Ports</h3>

<p>Some components (e.g. the logger or the canbus components) may create new ports
at runtime, based on their configuration. To integrate within Syskit, it is
necessary to declare that such creation is possible. This is done with the
<code>dynamic_input_port</code> and <code>dynamic_output_port</code> statements, possibly using a
regular expression as name pattern and either a message type or nil for "type
unknown".</p>

<p>The following for instance declares, in the Rock
<a href="https://github.com/rock-drivers/drivers-orogen-canbus">canbus::Task</a>, that
ports with arbitrary names might be added to the task interface, and that these
ports will have the /canbus/Message type.</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">dynamic_output_port</span> <span class="sr">/.*/</span><span class="p">,</span> <span class="s2">"/canbus/Message"</span>
</code></pre></div>
<p>oroGen currently provides no support for dynamic ports at the C++ level.
<code>dynamic_output_port</code> and <code>dynamic_input_port</code> are purely declarative, it is
the job of the component implementer to handle their creation and destruction.
This is details <a href="writing_the_hooks.html#dynamic_ports">later</a></p>

<p>Syskit expects dynamic ports to be created at configuration time and removed at
cleanup time. Dynamic ports are modelled in Syskit using <a href="../component_networks/dynamic_services.html">dynamic services</a></p>

<h2 id="inheritance">Inheritance</h2>

<p>It is possible to make the components inherit from each other, and have the
other oroGen features play well.</p>

<p>Given a <code>Task</code> base class, the subclass is defined with</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">task_context</span> <span class="s2">"SubTask"</span><span class="p">,</span> <span class="ss">subclasses: </span><span class="s2">"Task"</span> <span class="k">do</span>
<span class="k">end</span>
</code></pre></div>
<p>When one does so, the component's subclass inherits from the parent's class, in
the C++ way. This of course means that it has access to the methods defined on the parent
class. From a component point of view, it also means that it inherits the parent's class interface.</p>

<p>When inheriting between task contexts, the following constraints will apply:</p>

<ul>
  <li>it is not possible to add a task interface object (port, property, …) that
has the same name than one defined by the parent model.</li>
  <li>the child shares the parent's <a href="state_machine.html">state definitions</a></li>
</ul>

<p>Finally, "abstract task models", i.e. task models that are used as a base for
others, but which it would be meaningless to deploy since they don't have any
functionality can be marked as abstract with</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">task_context</span> <span class="s2">"SubTask"</span> <span class="k">do</span>
    <span class="n">abstract</span>
<span class="k">end</span>
</code></pre></div>
<p>One can also inherit from a task defined by another oroGen package. Import the
package first at the top of the <code>.orogen</code> file with</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">using_task_library</span> <span class="s2">"base_package"</span>
</code></pre></div>
<p>and subclass the task from <code>base_package</code> using its full name:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">task_context</span> <span class="s1">'Task'</span><span class="p">,</span> <span class="ss">subclasses: </span><span class="s2">"base_package::Task"</span> <span class="k">do</span>
<span class="k">end</span>
</code></pre></div>
<p class="next-page"><strong>Next</strong> let's have a look at the component <a href="state_machine.html">lifecycle state machine</a></p>


            </div>
        </div>
    </div>

    <script>
    $('.docs-sidebar').affix({
        offset: {
            top: $('.docs-sidebar').offset().top
        }
    });
    </script>


        <footer class="container-fluid text-center">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Building Robots with Rock and Syskit</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/doudou" property="cc:attributionName" rel="cc:attributionURL">Sylvain Joyeux</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. Copyright Sylvain Joyeux and Contributors
        </footer>
    </body>
</html>
