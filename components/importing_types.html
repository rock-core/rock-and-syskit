<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Building Robots with Rock and Syskit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>

    <body class="components components_importing_types">
            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" role="complementary">
                <nav class="docs-sidebar" data-spy="affix">
                    <ul class="nav"><li class='child'><a href="../">Building robots with Rock and Syskit</a></li><li class='parent'><span class='parent-label'><a href="../basics/">Basics</a></span><ul><li class='child'><a href="../basics/">Introduction</a></li><li class='child'><a href="../basics/installation.html">Installation</a></li><li class='child'><a href="../basics/day_to_day.html">Day-to-day Workspace Commands</a></li><li class='child'><a href="../basics/getting_started.html">Getting Started</a></li><li class='child'><a href="../basics/composition.html">Compositions</a></li><li class='child'><a href="../basics/constant_generator.html">Constant Generator</a></li><li class='child'><a href="../basics/devices.html">Profiles and Devices</a></li><li class='child'><a href="../basics/deployment.html">Deployment</a></li><li class='child'><a href="../basics/publishing.html">Publishing</a></li><li class='child'><a href="../basics/validation.html">Configuration Consistency</a></li><li class='child'><a href="../basics/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../runtime_overview/">Runtime Overview</a></span><ul><li class='child'><a href="../runtime_overview/">Introduction</a></li><li class='child'><a href="../runtime_overview/task_structure.html">Task Structures</a></li><li class='child'><a href="../runtime_overview/event_loop.html">Event Loop</a></li><li class='child'><a href="../runtime_overview/exceptions.html">Errors</a></li><li class='child'><a href="../runtime_overview/live_data.html">Live Data Visualization</a></li><li class='child'><a href="../runtime_overview/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../workspace/">Workspace and Packages</a></span><ul><li class='child'><a href="../workspace/">Introduction</a></li><li class='child'><a href="../workspace/conventions.html">Conventions</a></li><li class='child'><a href="../workspace/setup.html">Starting a New Project</a></li><li class='child'><a href="../workspace/add_packages.html">Adding new packages</a></li><li class='child'><a href="../workspace/os_dependencies.html">OS Dependencies</a></li><li class='child'><a href="../workspace/global_configuration.html">Global Configuration</a></li><li class='child'><a href="../workspace/testing.html">Test Integration</a></li><li class='child'><a href="../workspace/managing.html">Build configuration design</a></li><li class='child'><a href="../workspace/troubleshooting.html">Troubleshooting</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../libraries/">Libraries</a></span><ul><li class='child'><a href="../libraries/">Introduction</a></li><li class='child'><a href="../libraries/add_packages.html">Add packages</a></li><li class='child'><a href="../libraries/cpp_libraries.html">C++ Library Packages</a></li><li class='child'><a href="../libraries/geometric_transformations.html">Geometric Transformations in C++ Libraries</a></li><li class='child'><a href="../libraries/ruby_libraries.html">Ruby Library Packages</a></li></ul></li><li class='parent active'><span class='parent-label'><a href="./">Components</a></span><ul><li class='child'><a href="./">Writing Components</a></li><li class='child'><a href="orogen_packages.html">oroGen Packages</a></li><li class='child'><a href="defining_types.html">Defining Types</a></li><li class='child active'><a href="importing_types.html">Importing Types</a></li><li class='child'><a href="interface.html">Interface</a></li><li class='child'><a href="state_machine.html">State Machine</a></li><li class='child'><a href="writing_the_hooks.html">Writing the Hooks</a></li><li class='child'><a href="timestamping.html">Timestamping</a></li><li class='child'><a href="stream_aligner.html">Stream Aligner</a></li><li class='child'><a href="geometric_transformations.html">Geometric Transformations</a></li><li class='child'><a href="deployment.html">Deployments</a></li><li class='child'><a href="runtime.html">Runtime</a></li><li class='child'><a href="testing.html">Testing</a></li><li class='child'><a href="types_in_ruby.html">Types in Ruby</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../component_networks/">Designing Component Networks</a></span><ul><li class='child'><a href="../component_networks/">Introduction</a></li><li class='child'><a href="../component_networks/composition.html">Compositions</a></li><li class='child'><a href="../component_networks/profiles.html">Profiles</a></li><li class='child'><a href="../component_networks/reusable_networks.html">Reusable Networks</a></li><li class='child'><a href="../component_networks/devices_and_busses.html">Robot definition&colon; Devices and Busses</a></li><li class='child'><a href="../component_networks/dynamic_services.html">Dynamic Services</a></li><li class='child'><a href="../component_networks/geometric_transformations.html">Geometric Transformations</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../coordination/">Coordination</a></span><ul><li class='child'><a href="../coordination/">Introduction</a></li><li class='child'><a href="../coordination/generalities.html">Generalities</a></li><li class='child'><a href="../coordination/tasks_and_events.html">Tasks and Events</a></li><li class='child'><a href="../coordination/action_methods.html">Action Methods</a></li><li class='child'><a href="../coordination/action_state_machines.html">Action State Machines</a></li><li class='child'><a href="../coordination/component_networks.html">Component Networks</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../simulation/">Simulation with Gazebo</a></span><ul><li class='child'><a href="../simulation/">Introduction</a></li><li class='child'><a href="../simulation/models_links_and_joints.html">Models, Links, Joints and Sensors</a></li><li class='child'><a href="../simulation/plugins.html">Plugins</a></li><li class='child'><a href="../simulation/transformer.html">Transformer</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_error_handling/">Error Handling</a></span><ul><li class='child'><a href="../syskit_error_handling/">Introduction</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../log_management/">Log Management</a></span><ul><li class='child'><a href="../log_management/">Introduction</a></li><li class='child'><a href="../log_management/runtime.html">Log Generation at Runtime</a></li><li class='child'><a href="../log_management/datastore.html">Storing Logs</a></li><li class='child'><a href="../log_management/jupyter.html">Log Analysis with Jupyter</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../testing/">Testing and Debugging</a></span><ul><li class='child'><a href="../testing/">Introduction</a></li><li class='child'><a href="../testing/component.html">Component Tests</a></li><li class='child'><a href="../testing/integration.html">Integration Tests</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../cookbook/">Cookbook</a></span><ul><li class='child'><a href="../cookbook/">Introduction</a></li><li class='child'><a href="../cookbook/device_drivers.html">Device Drivers with iodrivers_base</a></li><li class='child'><a href="../cookbook/http_api.html">Control and Monitoring through a HTTP API</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../deprecations/">Deprecated Behaviors</a></span><ul><li class='child'><a href="../deprecations/">Introduction</a></li><li class='child'><a href="../deprecations/backward_compatible_naming.html">Backward compatible naming</a></li><li class='child'><a href="../deprecations/update_properties.html">Introduction of the `update_properties` method</a></li></ul></li></ul>
                </nav>
            </div>
            <div class="col-md-9" role="main">
                <h1 id="import" class="no_toc">Importing Types</h1>

<ul id="markdown-toc">
  <li><a href="#from-libraries-and-from-within-the-orogen-package-itself" id="markdown-toc-from-libraries-and-from-within-the-orogen-package-itself">From libraries and from within the oroGen package itself</a></li>
  <li><a href="#from_orogen" id="markdown-toc-from_orogen">From other oroGen packages (type definition, export and reuse)</a></li>
  <li><a href="#opaques" id="markdown-toc-opaques">Opaque Types</a></li>
  <li><a href="#type-packages" id="markdown-toc-type-packages">Creating an orogen package to export types</a></li>
</ul>

<h2 id="from-libraries-and-from-within-the-orogen-package-itself">From libraries and from within the oroGen package itself</h2>

<p>In an oroGen project, one adds one or more <code>import_types_from</code> statements to
include headers from within the oroGen package, headers from other packages or
to import all types that have already been defined within another oroGen
package. The template generated by <code>rock-create-orogen</code> has created a header
file for this purpose:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">import_types_from</span> <span class="s2">"myprojectTypes.hpp"</span>
</code></pre></div>
<p>Such headers must be self-contained, that is include all the headers they,
themselves, require.  Moreover, only the types that are <em>directly</em> defined in
the imported header (and the types they themselves use) will be exported in the
typekit. Finally, one can directly use types defined in a library, provided
that this library gives a pkg-config file for dependency discovery.</p>

<p>Let's consider a <code>drivers/hokuyo</code> package that would define a
<code>hokuyo::Statistics</code> structure. Assuming that this package (1) installs a
<code>hokuyo.pc</code> file - all Rock packages do by default - and (2) installs the
relevant header as <code>Statistics.hpp</code>, one can import the type with</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">using_library</span> <span class="s2">"hokuyo"</span>
<span class="n">import_types_from</span> <span class="s2">"hokuyo/Statistics.hpp"</span>
</code></pre></div>
<p class="note"><strong>Note</strong> the pkg-config name of a Rock library package is the package's basename
(i.e. <code>hokuyo</code> for <code>drivers/hokuyo</code>).</p>

<div class="important">
  <p><strong>Important</strong> The <code>using_library "library_name"</code> stanza
implicitly create a dependency between the oroGen package you're working on
and the library package. This dependency <strong>must</strong> be made explicit by adding
the corresponding <code>&lt;depend name="..." /&gt;</code> line to the oroGen package's
<a href="../workspace/add_packages.html#manifest_xml"><code>manifest.xml</code></a>.</p>

  <p>It is mandatory that this type of dependency defines a pkg-config file. All Rock
packages do, but 3rd party libraries may not. If they do not, you will have to
follow <a href="../libraries/cpp_libraries.html#unconventional_dependencies">this step-by-step</a> to
work around these.</p>
</div>

<h2 id="from_orogen">From other oroGen packages (type definition, export and reuse)</h2>

<p>A given type can be imported at the same time by more than one oroGen
package. The Rock component implementation supports this. However, this is
pretty wasteful in terms of compilation times and code size. One would rather
decide to import types that already have been used by other oroGen packages.
In some cases, one can also decide to create packages for the sole purpose of
having a common set of ready-to-use types, a subject we cover <a href="#type-packages">later in this
section</a>.</p>

<p>Just a bit of vocabulary here: a type is <em>defined</em> by an oroGen package if
it has been imported by it. It is however <em>exported</em> by an oroGen package if
the package registers this type within the Rock component type system. Only
<em>exported</em> types can be used on a component's interface. A limitation of
oroGen is that a type can only be exported by the package that defined it
first.</p>

<p>To reduce compilation time, oroGen packages that have task definitions will
only export the types these tasks use - the ones that are used on the task's
interface. This allows to reduce the amount of code to be compiled (and avoid
pollution in the type system) to what is necessary for the package.</p>

<p>Types that are exported by a given oroGen package can be reused within
another oroGen package with <code>import_types_from</code>, e.g.</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">import_types_from</span> <span class="s1">'base'</span>
<span class="c1"># /base/Time is now available. No new code will be generated</span>
</code></pre></div>
<p>In addition to the <code>import_types_from</code> stanza, one must add the corresponding
package to <code>manifest.xml</code>, e.g.:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="nt">&lt;depend</span> <span class="na">name=</span><span class="s">"base/orogen/types"</span> <span class="nt">/&gt;</span>
</code></pre></div>
<p class="note"><strong>Note</strong> the name of an oroGen package as used in <code>import_types_from</code> is the
package's basename (i.e. <code>hokuyo</code> for <code>drivers/orogen/hokuyo</code>). An oroGen
package and a library can share the same basename (e.g. <code>drivers/hokuyo</code> and
<code>drivers/orogen/hokuyo</code>). This is even a recommended behavior when an orogen
package is mainly tied to a certain library.</p>

<p>In case one needs to export extra types from a given package, it is feasible
by adding an <code>typekit.export_types</code> stanza to the orogen file:</p>

<div class="highlight"><pre class="highlight plaintext"><code>typekit.export_types "/some/other/type"
</code></pre></div>
<p class="next-page">The following description of <a href="#opaques">opaque types</a> and <a href="#type-packages">type import
packages</a> can be passed on a first reading. You can skip it to
go straight to <a href="interface.html">how component interfaces are defined</a>.</p>

<h2 id="opaques">Opaque Types</h2>

<p>Opaque types are a way to enable oroGen to handle types that it cannot handle
completely automatically. The general idea is that you provide oroGen with a
"marshalling structure" that (1) <a href="defining_types.html">it can understand</a> and
(2) can hold all the data that the "real type" holds. Then, you have to
implement two conversion functions: one that converts from the marshalling type,
and one to the marshalling type.</p>

<p>So, it involves doing one copy. What is the gain ?</p>

<p>Opaque types provide you with the advantage that other types that use opaque
types (i.e.  structures with fields that are from opaque types, std::vector,
arrays) will be automatically handled by oroGen. I.e. you write the conversion
function for the types that oroGen can't handle and let it do the rest of the
work.</p>

<p>Moreover, oroGen will be able to generate typekits for all the transports it
can handle.</p>

<p>Finally, the conversion to and from the marshalling type is only done in
inter-process transports. When communicating across threads, the data structure
is copied as-is.</p>

<p>To use opaque types, you first have to create a wrapper type (a.k.a.
"intermediate type") for the opaque. In the case of <code>Eigen::Vector3d</code>, a
suitable wrapper would be</p>

<div class="highlight"><pre class="highlight cpp"><code><span class="k">namespace</span> <span class="n">wrappers</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">Vector3d</span>
    <span class="p">{</span>
        <span class="kt">double</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div>
<p>The wrapper is usually defined within the oroGen package itself, in a
<code>wrappers/</code> subdirectory placed at the root of the package. It then needs to be
<a href="#import">imported with <code>import_types_from</code></a>.  Finally, one can use
<code>opaque_type</code> to declare the opaque.</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">import_types_from</span> <span class="s2">"wrappers/Vector3d.hpp"</span>
<span class="n">opaque_type</span> <span class="s2">"/Eigen/Vector3d"</span><span class="p">,</span> <span class="s2">"/wrappers/Vector3d"</span>
</code></pre></div>
<p>where <code>wrappers::Vector3d</code> is the marshalling structure defined in
<code>wrappers/Vector3d.hpp</code>. Moreover, if getting the definition of the opaque type
requires new include directories that are not yet added to the typekit through
the <a href="#import">using_library mechanism</a>, you will have to detect them in the
Ruby code and add them with the <code>include:</code> option</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">import_types_from</span> <span class="s2">"wrappers/Vector3d.hpp"</span>
<span class="n">opaque_type</span> <span class="s2">"/Eigen/Vector3d"</span><span class="p">,</span> <span class="s2">"/wrappers/Vector3d"</span><span class="p">,</span> <span class="ss">include: </span><span class="n">eigen_prefix</span>
</code></pre></div>
<p>Once you have re-generated the project, a typekit/ directory is created with
two files, <code>Opaques.cpp</code> and <code>Opaques.hpp</code> in it. These files hold the
<code>toIntermediate</code> and <code>fromIntermediate</code> conversion functions that should be
used by oroGen to convert the opaque to the wrapper and the wrapper to the
opaque. Note that any function will do: you may change the plain functions to
e.g. templates if you need to defined opaques for many types (as
<code>base/orogen/types</code> does <a href="https://github.com/rock-core/base-orogen-types/blob/master/typekit/Opaques.hpp">for the Eigen
types</a>).</p>

<p class="important"><strong>Updates to Opaques.hpp/Opaques.cpp</strong> If you add new opaques to an orogen
project that already has some, you will need to copy the corresponding
toIntermediate/fromIntermediate conversion functions manually from
templates/typekit/Opaques.cpp. Note that this is a general behavior: oroGen
will always refuse to modify a file that already exists, but update a "fresh"
template within <code>templates/</code>.</p>

<p>As explained, once you have defined an opaque type, oroGen will take care of
other types that <em>use</em> this opaque. For instance</p>

<div class="highlight"><pre class="highlight cpp"><code><span class="k">struct</span> <span class="nc">Position</span>
<span class="p">{</span>
    <span class="n">base</span><span class="o">::</span><span class="n">Time</span> <span class="n">time</span><span class="p">;</span>
    <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="n">position</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>can be used in your task interfaces without any modifications. This works for
structures, <code>std::vector</code> and static-size arrays. Before you may do this, however,
you need to <code>import_types_from</code> the orogen package that declared the opaque
in the first place.</p>

<h2 id="type-packages">Creating an orogen package to export types</h2>

<p>In some cases, one might want to export a set of types in order to have a common
base, but not depend on extra libraries that provide much more functionality. This
can be done by creating an oroGen package for the purpose of the type export. This
is a package without any task definition, and only <code>import_types_from</code> and
<code>export_types</code> statement(s)</p>

<p>Let's assume we want to re-create the <code>drivers/orogen/raw_io</code> package:</p>

<div class="highlight"><pre class="highlight plaintext"><code>acd
cd drivers/orogen
rock-create-orogen raw_io
cd raw_io
# Edit raw_io.orogen
</code></pre></div>
<p>If we are going to use this package only for type definitions, you will have to
delete all the <code>task_context</code> definitions. The orogen file will end up looking
like this:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="nb">name</span> <span class="s2">"raw_io"</span>
<span class="n">version</span> <span class="s2">"0.1"</span>

<span class="c1"># Import types from other orgen projects as well as</span>
<span class="c1"># C++ headers within the orogen package itself</span>
<span class="n">import_types_from</span> <span class="s2">"..."</span>
<span class="n">import_types_from</span> <span class="s2">"..."</span>
<span class="n">import_types_from</span> <span class="s2">"..."</span>
<span class="n">import_types_from</span> <span class="s2">"..."</span>

<span class="c1"># Import types from libraries</span>
<span class="n">using_library</span> <span class="s2">"other_lib"</span>
<span class="n">import_types_from</span> <span class="s2">"other_lib/Header.hpp"</span>

<span class="c1"># Choose which types are going to be usable on</span>
<span class="c1"># component interfaces</span>
<span class="n">typekit</span><span class="p">.</span><span class="nf">export_types</span> <span class="s2">"/name/of/type"</span><span class="p">,</span>
    <span class="s2">"/name/of/another/type"</span>
</code></pre></div>
<p>Once this is done, <a href="../workspace/add_packages.html#orogen">add the package to your build
configuration</a></p>

            </div>
        </div>
    </div>

    <script>
    $('.docs-sidebar').affix({
        offset: {
            top: $('.docs-sidebar').offset().top
        }
    });
    </script>


        <footer class="container-fluid text-center">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Building Robots with Rock and Syskit</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/doudou" property="cc:attributionName" rel="cc:attributionURL">Sylvain Joyeux</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. Copyright Sylvain Joyeux and Contributors
        </footer>
    </body>
</html>
