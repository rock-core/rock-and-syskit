<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Building Robots with Rock and Syskit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>

    <body class="basics basics_deployment">
            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" role="complementary">
                <nav class="docs-sidebar" data-spy="affix">
                    <ul class="nav"><li class='child'><a href="../">Building robots with Rock and Syskit</a></li><li class='parent active'><span class='parent-label'><a href="./">Basics</a></span><ul><li class='child'><a href="./">Introduction</a></li><li class='child'><a href="installation.html">Installation</a></li><li class='child'><a href="day_to_day.html">Day-to-day Workspace Commands</a></li><li class='child'><a href="getting_started.html">Getting Started</a></li><li class='child'><a href="composition.html">Compositions</a></li><li class='child'><a href="constant_generator.html">Constant Generator</a></li><li class='child'><a href="devices.html">Profiles and Devices</a></li><li class='child active'><a href="deployment.html">Deployment</a></li><li class='child'><a href="publishing.html">Publishing</a></li><li class='child'><a href="validation.html">Configuration Consistency</a></li><li class='child'><a href="recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../runtime_overview/">Runtime Overview</a></span><ul><li class='child'><a href="../runtime_overview/">Introduction</a></li><li class='child'><a href="../runtime_overview/task_structure.html">Task Structures</a></li><li class='child'><a href="../runtime_overview/event_loop.html">Event Loop</a></li><li class='child'><a href="../runtime_overview/exceptions.html">Errors</a></li><li class='child'><a href="../runtime_overview/live_data.html">Live Data Visualization</a></li><li class='child'><a href="../runtime_overview/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../workspace/">Workspace and Packages</a></span><ul><li class='child'><a href="../workspace/">Introduction</a></li><li class='child'><a href="../workspace/conventions.html">Conventions</a></li><li class='child'><a href="../workspace/setup.html">Starting a New Project</a></li><li class='child'><a href="../workspace/add_packages.html">Adding new packages</a></li><li class='child'><a href="../workspace/os_dependencies.html">OS Dependencies</a></li><li class='child'><a href="../workspace/global_configuration.html">Global Configuration</a></li><li class='child'><a href="../workspace/testing.html">Test Integration</a></li><li class='child'><a href="../workspace/managing.html">Build configuration design</a></li><li class='child'><a href="../workspace/troubleshooting.html">Troubleshooting</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../libraries/">Libraries</a></span><ul><li class='child'><a href="../libraries/">Introduction</a></li><li class='child'><a href="../libraries/add_packages.html">Add packages</a></li><li class='child'><a href="../libraries/cpp_libraries.html">C++ Library Packages</a></li><li class='child'><a href="../libraries/geometric_transformations.html">Geometric Transformations in C++ Libraries</a></li><li class='child'><a href="../libraries/ruby_libraries.html">Ruby Library Packages</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../components/">Components</a></span><ul><li class='child'><a href="../components/">Writing Components</a></li><li class='child'><a href="../components/orogen_packages.html">oroGen Packages</a></li><li class='child'><a href="../components/defining_types.html">Defining Types</a></li><li class='child'><a href="../components/importing_types.html">Importing Types</a></li><li class='child'><a href="../components/interface.html">Interface</a></li><li class='child'><a href="../components/state_machine.html">State Machine</a></li><li class='child'><a href="../components/writing_the_hooks.html">Writing the Hooks</a></li><li class='child'><a href="../components/timestamping.html">Timestamping</a></li><li class='child'><a href="../components/stream_aligner.html">Stream Aligner</a></li><li class='child'><a href="../components/geometric_transformations.html">Geometric Transformations</a></li><li class='child'><a href="../components/deployment.html">Deployments</a></li><li class='child'><a href="../components/runtime.html">Runtime</a></li><li class='child'><a href="../components/testing.html">Testing</a></li><li class='child'><a href="../components/types_in_ruby.html">Types in Ruby</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../component_networks/">Designing Component Networks</a></span><ul><li class='child'><a href="../component_networks/">Introduction</a></li><li class='child'><a href="../component_networks/composition.html">Compositions</a></li><li class='child'><a href="../component_networks/profiles.html">Profiles</a></li><li class='child'><a href="../component_networks/reusable_networks.html">Reusable Networks</a></li><li class='child'><a href="../component_networks/devices_and_busses.html">Robot definition&colon; Devices and Busses</a></li><li class='child'><a href="../component_networks/dynamic_services.html">Dynamic Services</a></li><li class='child'><a href="../component_networks/geometric_transformations.html">Geometric Transformations</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../coordination/">Coordination</a></span><ul><li class='child'><a href="../coordination/">Introduction</a></li><li class='child'><a href="../coordination/generalities.html">Generalities</a></li><li class='child'><a href="../coordination/tasks_and_events.html">Tasks and Events</a></li><li class='child'><a href="../coordination/action_methods.html">Action Methods</a></li><li class='child'><a href="../coordination/action_state_machines.html">Action State Machines</a></li><li class='child'><a href="../coordination/component_networks.html">Component Networks</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../simulation/">Simulation with Gazebo</a></span><ul><li class='child'><a href="../simulation/">Introduction</a></li><li class='child'><a href="../simulation/models_links_and_joints.html">Models, Links, Joints and Sensors</a></li><li class='child'><a href="../simulation/plugins.html">Plugins</a></li><li class='child'><a href="../simulation/transformer.html">Transformer</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_error_handling/">Error Handling</a></span><ul><li class='child'><a href="../syskit_error_handling/">Introduction</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../log_management/">Log Management</a></span><ul><li class='child'><a href="../log_management/">Introduction</a></li><li class='child'><a href="../log_management/runtime.html">Log Generation at Runtime</a></li><li class='child'><a href="../log_management/datastore.html">Storing Logs</a></li><li class='child'><a href="../log_management/jupyter.html">Log Analysis with Jupyter</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../testing/">Testing and Debugging</a></span><ul><li class='child'><a href="../testing/">Introduction</a></li><li class='child'><a href="../testing/component.html">Component Tests</a></li><li class='child'><a href="../testing/integration.html">Integration Tests</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../cookbook/">Cookbook</a></span><ul><li class='child'><a href="../cookbook/">Introduction</a></li><li class='child'><a href="../cookbook/device_drivers.html">Device Drivers with iodrivers_base</a></li><li class='child'><a href="../cookbook/http_api.html">Control and Monitoring through a HTTP API</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../deprecations/">Deprecated Behaviors</a></span><ul><li class='child'><a href="../deprecations/">Introduction</a></li><li class='child'><a href="../deprecations/backward_compatible_naming.html">Backward compatible naming</a></li><li class='child'><a href="../deprecations/update_properties.html">Introduction of the `update_properties` method</a></li></ul></li></ul>
                </nav>
            </div>
            <div class="col-md-9" role="main">
                <h1 class="no_toc" id="deployment">Deployment</h1>

<div class="callout callout-info">
  <p><strong>Where are we ?</strong> A few things are missing before we can actually run <a href="devices.html">the
network we just created</a>. Mainly related to giving names to
actual components, providing proper configurations and registering an action so
that we can tell Syskit to start our network.</p>
</div>

<ul id="markdown-toc">
  <li><a href="#use_deployment" id="markdown-toc-use_deployment">Component deployment</a></li>
  <li><a href="#configuration" id="markdown-toc-configuration">Component configuration</a></li>
  <li><a href="#actions" id="markdown-toc-actions">Building the system's action interface</a></li>
  <li><a href="#running-the-simulation-and-app" id="markdown-toc-running-the-simulation-and-app">Running the simulation and app</a></li>
</ul>

<h2 id="use_deployment">Component deployment</h2>

<p>When declared in oroGen files, components are an encapsulation of a
function. At this stage, a "component" is really just a class which embeds code
in a specific, normalized way, and that has defined inputs, outputs and
configuration parameters.</p>

<p>To actually run a component, one needs to declare how it will be supported by
the operating system's runtime ressources (how the components are mapped to
processes and threads), and when the component will be processing its data
(periodically, triggered by its inputs). Moreover, the component is given a name
so that it can be discovered by Rock's inspection tools, and so that its outputs
can be found in the data logged at runtime.</p>

<p>All oroGen components have a default deployment scheme of one component per
process. The triggering mechanism does not have a default, but the
<code>port_driven</code> scheme (where the component is triggered whenever data is
received on its inputs) is commonly used. If you look into the
<code>cart_ctrl_wdls.orogen</code> file in <code>control/orogen/cart_ctrl_wdls</code>, you would see
that it is indeed what the package components uses.</p>

<p id="requires">One usually starts with the defaults defined in the oroGen file. We therefore
only have left to give a name to the components Syskit is using. This is done
in the robot's config file with:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="no">Robot</span><span class="p">.</span><span class="nf">requires</span> <span class="k">do</span>
    <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_gazebo_world</span><span class="p">(</span><span class="s1">'empty_world'</span><span class="p">)</span>

    <span class="nb">require</span> <span class="s1">'syskit_basics/models/profiles/gazebo/arm_control'</span>
    <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_deployment</span> <span class="no">OroGen</span><span class="p">.</span><span class="nf">cart_ctrl_wdls</span><span class="o">.</span><span class="no">CartCtrl</span> <span class="o">=&gt;</span> <span class="s1">'arm_pos2twist'</span>
    <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_deployment</span> <span class="no">OroGen</span><span class="p">.</span><span class="nf">cart_ctrl_wdls</span><span class="o">.</span><span class="no">WDLSSolver</span> <span class="o">=&gt;</span> <span class="s1">'arm_twist2joint'</span>
    <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_deployment</span> <span class="no">OroGen</span><span class="p">.</span><span class="nf">robot_frames</span><span class="o">.</span><span class="no">SingleChainPublisher</span> <span class="o">=&gt;</span> <span class="s1">'arm_chain_publisher'</span>
    <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_ruby_tasks</span> <span class="no">SyskitBasics</span><span class="o">::</span><span class="no">Compositions</span><span class="o">::</span><span class="no">ArmCartesianConstantCommandGenerator</span> <span class="o">=&gt;</span> <span class="s1">'arm_constant_setpoint'</span>
    <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_ruby_tasks</span> <span class="no">SyskitBasics</span><span class="o">::</span><span class="no">Compositions</span><span class="o">::</span><span class="no">JointPositionConstantGenerator</span> <span class="o">=&gt;</span> <span class="s1">'joint_position_setpoint'</span>
<span class="k">end</span>
</code></pre></div>
<p class="callout callout-info">Now that we've required our toplevel profile in the robot configuration file,
we can inspect our app using the IDE by simply providing the <code>-rgazebo</code> flag.
Only new files, not yet required by the config file, must be specified on the
command line.</p>

<h2 id="configuration">Component configuration</h2>

<p>Configuration of components in a Syskit system is split into two parts:</p>

<ul>
  <li>"dynamic" configuration: parameters that cannot be known at design time, will
be changed each time an action is started, or are to be kept consistent
system-wide (such as e.g. information that can be extracted from the SDF
model). These are represented as <strong>task arguments</strong>. This is how the
setpoint
of the cartesian controller <a href="constant_generator.html">is handled</a>.</li>
  <li>"static" configuration: parameters that are known at design time. Most
of the algorithm parameters fit into this category. These are the subject
of this section.</li>
</ul>

<h3 class="no_toc" id="static-configuration-of-orogen-components">Static configuration of oroGen components</h3>

<p>The static configuration is stored within YAML files in <code>config/orogen/</code>. Each
file is named after the component model that is configured, so for instance
<code>config/orogen/cart_ctrl_wdls::WDLSSolver.yml</code> stores the configuration of all
components under that name. Each file can contain multiple configurations
within sections, but for now we will only use the <code>default</code> configuration,
which is the one that is loaded by default unless specified otherwise.</p>

<p>Let's generate configuration file templates for the components we are using. The
files are generated with the default configuration exposed by the components.</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ syskit gen orogenconf cart_ctrl_wdls::WDLSSolver
      create  config/orogen/
      create  config/orogen/cart_ctrl_wdls::WDLSSolver.yml
$ syskit gen orogenconf cart_ctrl_wdls::CartCtrl
      exists  config/orogen/
      create  config/orogen/cart_ctrl_wdls::CartCtrl.yml
$ syskit gen orogenconf robot_frames::SingleChainPublisher
      exists  config/orogen/
      create  config/orogen/robot_frames::SingleChainPublisher.yml
</code></pre></div>
<p>The generators create a configuration file for each component class, containing the default value of every property.
Let's look at them one by one, to see what needs to actually be configured.</p>

<ul>
  <li>
    <p><code>cart_ctrl_wdls::WDLSSolver</code>. There are robot model parameters as well as tip
and root. The former should be extracted from the SDF configuration, but the
tip and root have to be set. The only algorithm parameter that does not seem to
have a sane default is the <code>lambda</code> parameter. The documentation mentions 0.1
has a known-good parameter for some arm, let's pick that and keep in mind
that it might be wrong.</p>

    <p>The root and tip in our case are the base and hand of the robot. So <code>root</code> should
be <code>ur10::base</code> and <code>tip</code> should be <code>ur10::wrist_3</code>. One can find this out by looking at
the SDF file.  Alternatively, the chain can be
inspected using the <code>rock-transformer</code> tool:</p>

    <p>The parameters that have to be set should look like the following. Better
keep the rest, as it provides documentation about which parameters are
available.</p>

<div class="highlight"><pre class="highlight yaml"><code><span class="na">root</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ur10::base'</span>
<span class="na">tip</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ur10::wrist_3'</span>
</code></pre></div>  </li>
  <li><code>cart_ctrl_wdls::CartCtrl</code>. The one parameter that is probably best changed is
the max output. The component's designer decided to pick <code>RigidBodyState</code> to
represent a twist, which means that we only need to update the velocity
and angular velocity fields. Let's set <code>0.1</code> in linear and <code>2.deg</code> in angular
(the <code>.deg</code> suffix will convert a degree value in radians).</li>
  <li>
    <p><code>robot_frames::SingleChainPublisher</code> only has robot model that we will
extract from the SDF model, and the tip/root parameters that have to be set</p>

<div class="highlight"><pre class="highlight yaml"><code><span class="na">chain</span><span class="pi">:</span>
  <span class="na">root_link</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ur10::base'</span>
  <span class="na">tip_link</span><span class="pi">:</span> <span class="s1">'</span><span class="s">ur10::wrist_3'</span>
</code></pre></div>  </li>
</ul>

<p class="callout callout-info"><strong>Note</strong> one might want at some point to use a task argument for the tip and
root parameters of <code>SingleChainPublisher</code> and <code>WDLSSolver</code>, to ensure
consistency between the components.</p>

<div class="fluid-video">
  <iframe width="853" height="480" src="https://www.youtube.com/embed/ShYmPgIZ1Oc?rel=0&amp;showinfo=0" frameborder="0" allowfullscreen=""></iframe>
</div>

<h3 class="no_toc" id="dynamic-and-system-wide-configuration">Dynamic and system-wide configuration</h3>

<p>The robot model need to be extracted from the SDF and passed to the components
that require it. The convention when integrating SDF models in Syskit is to
extract the relevant parts of the XML model as an XML string and provide only
this to the components. This centralizes the difficulty of resolving the
relationships between SDF models, and provides flexibility to tune the model
before it is passed to the component.</p>

<div class="panel panel-warning">
  <div class="panel-heading">
    <p><a class="btn btn-warning" role="button" data-toggle="collapse" href="#sdf_load" aria-expanded="false" aria-controls="sdf_load">
  Advanced
</a><span class="advanced_description">Mechanisms involved in SDF file loading in Rock</span></p>
  </div>

  <div class="collapse panel-body" id="sdf_load">
    <p>The difficulty when loading a SDF file is that SDF allows files to refer to
each other through the include mechanism, which can be used in a
<a href="http://sdformat.org/spec?ver=1.6&amp;elem=world#world_include">world</a> as well as a
<a href="http://sdformat.org/spec?ver=1.6&amp;elem=model#model_include">model</a> tag. Within
Gazebo, the include tags are resolved by searching through the
<code>GAZEBO_MODEL_PATH</code> environment variable. The SDF integration in Syskit automatically
augments this environment variable with the <code>models/sdf/</code> folders found within the <a href="getting_started.html#syskit_gazebo_configuration">app search path</a>.</p>

    <p>In order to avoid complexities tied to this mechanism, the preferred way to integrate SDF in components in a Syskit system is to provide the XML model as a string instead of as a file. This ensures that Syskit and the components share the same model.</p>
  </div>
</div>

<p>The <code>use_sdf_model</code> statement stores the model object on the profile object.
The most natural way would be to pass the <code>Base</code> profile, that represents the
robot model, as a <code>robot</code> argument to the control compositions until the oroGen
components. We can then make sure that argument is passed to the oroGen components
themselves.</p>

<p>We've already seen <a href="constant_generator.html#composition_forward_argument">how to forward a composition argument to its child</a>, so let's apply that to the compositions:</p>

<p>In <code>models/compositions/arm_cartesian_constant_control_wdls.rb</code></p>

<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ArmCartesianConstantControlWdls</span> <span class="o">&lt;</span> <span class="no">Syskit</span><span class="o">::</span><span class="no">Composition</span>
    <span class="c1"># The robot model that is to be used</span>
    <span class="c1">#</span>
    <span class="c1"># This must be the enclosing profile object that has the use_sdf_model call</span>
    <span class="c1">#</span>
    <span class="c1"># @return [Profile]</span>
    <span class="n">argument</span> <span class="ss">:robot</span>
    <span class="o">...</span>
    <span class="n">add</span><span class="p">(</span><span class="no">ArmCartesianControlWdls</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'control'</span><span class="p">).</span>
        <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="n">from</span><span class="p">(</span><span class="ss">:parent_task</span><span class="p">).</span><span class="nf">robot</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>and in <code>models/compositions/arm_cartesian_control_wdls.rb</code></p>

<div class="highlight"><pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">ArmCartesianControlWdls</span> <span class="o">&lt;</span> <span class="no">Syskit</span><span class="o">::</span><span class="no">Composition</span>
    <span class="c1"># The robot model that is to be used</span>
    <span class="c1">#</span>
    <span class="c1"># This must be the enclosing profile object that has the use_sdf_model call</span>
    <span class="c1">#</span>
    <span class="c1"># @return [Profile]</span>
    <span class="n">argument</span> <span class="ss">:robot</span>
    <span class="o">...</span>
    <span class="n">add</span><span class="p">(</span><span class="no">OroGen</span><span class="p">.</span><span class="nf">cart_ctrl_wdls</span><span class="o">.</span><span class="no">WDLSSolver</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'twist2joint_velocity'</span><span class="p">).</span>
        <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="n">from</span><span class="p">(</span><span class="ss">:parent_task</span><span class="p">).</span><span class="nf">robot</span><span class="p">)</span>
    <span class="n">add</span><span class="p">(</span><span class="no">OroGen</span><span class="p">.</span><span class="nf">robot_frames</span><span class="o">.</span><span class="no">SingleChainPublisher</span><span class="p">,</span> <span class="ss">as: </span><span class="s1">'joint2pose'</span><span class="p">).</span>
        <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="n">from</span><span class="p">(</span><span class="ss">:parent_task</span><span class="p">).</span><span class="nf">robot</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p>Since the <code>ArmControl</code> profile is specific to the <code>gazebo</code> robot, we can inject
the relevant robot in the profile directly:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="n">define</span> <span class="s1">'arm_cartesian_constant_control'</span><span class="p">,</span>
    <span class="no">Compositions</span><span class="o">::</span><span class="no">ArmCartesianConstantControlWdls</span><span class="p">.</span>
        <span class="nf">use</span><span class="p">(</span><span class="no">Base</span><span class="p">.</span><span class="nf">ur10_dev</span><span class="p">).</span>
        <span class="nf">with_arguments</span><span class="p">(</span><span class="ss">robot: </span><span class="no">Base</span><span class="p">)</span>
</code></pre></div>
<p id="orogen_extension_files">We need to modify the oroGen component models to use the robot argument.
Since oroGen components are auto-generated by Syskit, there's a special
mechanism to allow modifying the generated classes after the fact. When Syskit
loads an oroGen package, and after it has created the task classes, it will attempt to
load a file named like the project in <code>models/orogen/</code>. In the case of the
<code>robot_frames</code> project, this would be <code>models/orogen/robot_frames.rb</code>.</p>

<p>In the IDE, when displaying a task model under the <code>OroGen</code> namespace, a project
that has no associated extension file in <code>models/orogen/</code> has the following message:</p>

<p><img src="media/no_extension_file.png" alt="Message displayed by the IDE if there are no extension files" class="fullwidth" /></p>

<p>Let's do exactly that</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ syskit gen orogen cart_ctrl_wdls
      create  models/orogen
      create  test/orogen
      create  models/orogen/cart_ctrl_wdls.rb
      create  test/orogen/test_cart_ctrl_wdls.rb
$ syskit gen orogen robot_frames
      exists  models/orogen
      exists  test/orogen
      create  models/orogen/robot_frames.rb
      create  test/orogen/test_robot_frames.rb
</code></pre></div>
<p>After hitting the IDE's reload button, the IDE displays the path to the extension file:</p>

<p><img src="media/orogen_extension_file.png" alt="Message displayed by the IDE if there is an extension files" class="fullwidth" /></p>

<p>Let's edit first <code>models/orogen/cart_ctrl_wdls.rb</code>. There is one <code>Syskit.extend_model</code>
statement per task model in the project, but we're currently only interested in
the <code>WDLSSolver</code> task. Let's add the <code>robot</code> argument, and tune the
<code>configure</code> method that is described in the template to forward the model on to
the task's properties.</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="no">Syskit</span><span class="p">.</span><span class="nf">extend_model</span> <span class="no">OroGen</span><span class="p">.</span><span class="nf">cart_ctrl_wdls</span><span class="o">.</span><span class="no">WDLSSolver</span> <span class="k">do</span>
    <span class="n">argument</span> <span class="ss">:robot</span>
    <span class="k">def</span> <span class="nf">configure</span>
        <span class="k">super</span> <span class="c1"># call super as described in the template</span>

        <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model</span> <span class="o">=</span> <span class="n">robot</span><span class="p">.</span><span class="nf">sdf_model</span><span class="p">.</span><span class="nf">make_root</span><span class="p">.</span><span class="nf">to_xml_string</span>
        <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model_format</span> <span class="o">=</span> <span class="ss">:ROBOT_MODEL_SDF</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>and in <code>models/orogen/robot_frames.rb</code>:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="no">Syskit</span><span class="p">.</span><span class="nf">extend_model</span> <span class="no">OroGen</span><span class="p">.</span><span class="nf">robot_frames</span><span class="o">.</span><span class="no">SingleChainPublisher</span> <span class="k">do</span>
    <span class="n">argument</span> <span class="ss">:robot</span>
    <span class="k">def</span> <span class="nf">configure</span>
        <span class="k">super</span> <span class="c1"># call super as described in the template</span>

        <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model</span> <span class="o">=</span> <span class="n">robot</span><span class="p">.</span><span class="nf">sdf_model</span><span class="p">.</span><span class="nf">make_root</span><span class="p">.</span><span class="nf">to_xml_string</span>
        <span class="n">properties</span><span class="p">.</span><span class="nf">robot_model_format</span> <span class="o">=</span> <span class="ss">:ROBOT_MODEL_SDF</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<h2 id="actions">Building the system's action interface</h2>

<p>A Syskit application exports functionality to the outside world as <em>actions</em>.
The only thing we will see about actions in this section is that they have a name,
arguments and a lifetime. They either finish by themselves – if they have a
goal – or run forever until they are "dropped" by the app's user.</p>

<p>What we will see here is how to export the <a href="devices.html#profile_define">profile
definition</a> as an action on the robot's action
interface so that we can finally start it.</p>

<p>Every robot have a 'main' interface that is setup in the robot configuration
file. Syskit profiles are added in the action interface there, so that their
definitions are exported as an action with a <code>_def</code> suffix.</p>

<p id="main">Let's modify the <code>actions</code> block in <code>config/robots/gazebo.rb</code> to have:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="no">Robot</span><span class="p">.</span><span class="nf">actions</span> <span class="k">do</span>
    <span class="n">use_profile</span> <span class="no">SyskitBasics</span><span class="o">::</span><span class="no">Profiles</span><span class="o">::</span><span class="no">Gazebo</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">use_profile</span> <span class="no">SyskitBasics</span><span class="o">::</span><span class="no">Profiles</span><span class="o">::</span><span class="no">Gazebo</span><span class="o">::</span><span class="no">ArmControl</span>
<span class="k">end</span>
</code></pre></div>
<p class="callout callout-info"><strong>Note</strong>: the profile is available in the actions block because <a href="#requires">we've loaded it in the <code>requires</code> block</a></p>

<p>After modifying the config file, the IDE needs to be quit and started again. We
can then look at the <code>Main</code> interface and see that it indeed has <code>_dev</code> actions for
the devices in <code>Base</code>, and <code>_def</code> actions for the definitions in <code>ArmControl</code>.</p>

<p><img src="media/main_action_with_arm_control_def.png" alt="The Main interface with the arm control definition" class="fullwidth" /></p>

<p>Let's now run it</p>

<h2 id="running-the-simulation-and-app">Running the simulation and app</h2>

<p>Start the simulation with</p>

<div class="highlight"><pre class="highlight plaintext"><code>rock-gazebo empty_world
</code></pre></div>
<p>Once started, the simulation can stay running regardless of whether the Syskit
app itself gets restarted. You can then start the app using the IDE, and
send the command through the Syskit shell. The following video show you the process. Its goal
is to give you a feeling for Syskit's runtime workflow. Detailed explanations will come later <a href="../runtime_overview/">in the runtime overview</a></p>

<div class="fluid-video" id="final_video">
  <iframe width="853" height="480" src="https://www.youtube.com/embed/JrgS23xEK9g?rel=0&amp;showinfo=0" frameborder="0" allowfullscreen=""></iframe>
</div>

<p class="next-page"><strong>Next</strong>: Before we move on to the Syskit runtime aspects, you may pass
*through an extension of the configuration code that <a href="validation.html">validates its
*consistency</a>. This is a more advanced topic, so you may also
*go straight to <a href="publishing.html">publishing the package</a> and go back to it at
*a later time.</p>

            </div>
        </div>
    </div>

    <script>
    $('.docs-sidebar').affix({
        offset: {
            top: $('.docs-sidebar').offset().top
        }
    });
    </script>


        <footer class="container-fluid text-center">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Building Robots with Rock and Syskit</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/doudou" property="cc:attributionName" rel="cc:attributionURL">Sylvain Joyeux</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. Copyright Sylvain Joyeux and Contributors
        </footer>
    </body>
</html>
