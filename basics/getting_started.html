<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Building Robots with Rock and Syskit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>

    <body class="basics basics_getting_started">
            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" role="complementary">
                <nav class="docs-sidebar" data-spy="affix">
                    <ul class="nav"><li class='child'><a href="../">Building robots with Rock and Syskit</a></li><li class='parent active'><span class='parent-label'><a href="./">Basics</a></span><ul><li class='child'><a href="./">Introduction</a></li><li class='child'><a href="installation.html">Installation</a></li><li class='child'><a href="day_to_day.html">Day-to-day Workspace Commands</a></li><li class='child active'><a href="getting_started.html">Getting Started</a></li><li class='child'><a href="composition.html">Compositions</a></li><li class='child'><a href="constant_generator.html">Constant Generator</a></li><li class='child'><a href="devices.html">Profiles and Devices</a></li><li class='child'><a href="deployment.html">Deployment</a></li><li class='child'><a href="publishing.html">Publishing</a></li><li class='child'><a href="validation.html">Configuration Consistency</a></li><li class='child'><a href="recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../runtime_overview/">Runtime Overview</a></span><ul><li class='child'><a href="../runtime_overview/">Introduction</a></li><li class='child'><a href="../runtime_overview/task_structure.html">Task Structures</a></li><li class='child'><a href="../runtime_overview/event_loop.html">Event Loop</a></li><li class='child'><a href="../runtime_overview/exceptions.html">Errors</a></li><li class='child'><a href="../runtime_overview/live_data.html">Live Data Visualization</a></li><li class='child'><a href="../runtime_overview/recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../workspace/">Workspace and Packages</a></span><ul><li class='child'><a href="../workspace/">Introduction</a></li><li class='child'><a href="../workspace/conventions.html">Conventions</a></li><li class='child'><a href="../workspace/setup.html">Starting a New Project</a></li><li class='child'><a href="../workspace/add_packages.html">Adding new packages</a></li><li class='child'><a href="../workspace/os_dependencies.html">OS Dependencies</a></li><li class='child'><a href="../workspace/global_configuration.html">Global Configuration</a></li><li class='child'><a href="../workspace/testing.html">Test Integration</a></li><li class='child'><a href="../workspace/managing.html">Build configuration design</a></li><li class='child'><a href="../workspace/troubleshooting.html">Troubleshooting</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../libraries/">Libraries</a></span><ul><li class='child'><a href="../libraries/">Introduction</a></li><li class='child'><a href="../libraries/add_packages.html">Add packages</a></li><li class='child'><a href="../libraries/cpp_libraries.html">C++ Library Packages</a></li><li class='child'><a href="../libraries/geometric_transformations.html">Geometric Transformations in C++ Libraries</a></li><li class='child'><a href="../libraries/ruby_libraries.html">Ruby Library Packages</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../components/">Components</a></span><ul><li class='child'><a href="../components/">Writing Components</a></li><li class='child'><a href="../components/orogen_packages.html">oroGen Packages</a></li><li class='child'><a href="../components/defining_types.html">Defining Types</a></li><li class='child'><a href="../components/importing_types.html">Importing Types</a></li><li class='child'><a href="../components/interface.html">Interface</a></li><li class='child'><a href="../components/state_machine.html">State Machine</a></li><li class='child'><a href="../components/writing_the_hooks.html">Writing the Hooks</a></li><li class='child'><a href="../components/timestamping.html">Timestamping</a></li><li class='child'><a href="../components/stream_aligner.html">Stream Aligner</a></li><li class='child'><a href="../components/geometric_transformations.html">Geometric Transformations</a></li><li class='child'><a href="../components/deployment.html">Deployments</a></li><li class='child'><a href="../components/runtime.html">Runtime</a></li><li class='child'><a href="../components/testing.html">Testing</a></li><li class='child'><a href="../components/types_in_ruby.html">Types in Ruby</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../component_networks/">Designing Component Networks</a></span><ul><li class='child'><a href="../component_networks/">Introduction</a></li><li class='child'><a href="../component_networks/composition.html">Compositions</a></li><li class='child'><a href="../component_networks/profiles.html">Profiles</a></li><li class='child'><a href="../component_networks/reusable_networks.html">Reusable Networks</a></li><li class='child'><a href="../component_networks/devices_and_busses.html">Robot definition&colon; Devices and Busses</a></li><li class='child'><a href="../component_networks/dynamic_services.html">Dynamic Services</a></li><li class='child'><a href="../component_networks/geometric_transformations.html">Geometric Transformations</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../coordination/">Coordination</a></span><ul><li class='child'><a href="../coordination/">Introduction</a></li><li class='child'><a href="../coordination/generalities.html">Generalities</a></li><li class='child'><a href="../coordination/tasks_and_events.html">Tasks and Events</a></li><li class='child'><a href="../coordination/action_methods.html">Action Methods</a></li><li class='child'><a href="../coordination/action_state_machines.html">Action State Machines</a></li><li class='child'><a href="../coordination/component_networks.html">Component Networks</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../simulation/">Simulation with Gazebo</a></span><ul><li class='child'><a href="../simulation/">Introduction</a></li><li class='child'><a href="../simulation/models_links_and_joints.html">Models, Links, Joints and Sensors</a></li><li class='child'><a href="../simulation/plugins.html">Plugins</a></li><li class='child'><a href="../simulation/transformer.html">Transformer</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_error_handling/">Error Handling</a></span><ul><li class='child'><a href="../syskit_error_handling/">Introduction</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../log_management/">Log Management</a></span><ul><li class='child'><a href="../log_management/">Introduction</a></li><li class='child'><a href="../log_management/runtime.html">Log Generation at Runtime</a></li><li class='child'><a href="../log_management/datastore.html">Storing Logs</a></li><li class='child'><a href="../log_management/jupyter.html">Log Analysis with Jupyter</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../testing/">Testing and Debugging</a></span><ul><li class='child'><a href="../testing/">Introduction</a></li><li class='child'><a href="../testing/component.html">Component Tests</a></li><li class='child'><a href="../testing/integration.html">Integration Tests</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../cookbook/">Cookbook</a></span><ul><li class='child'><a href="../cookbook/">Introduction</a></li><li class='child'><a href="../cookbook/device_drivers.html">Device Drivers with iodrivers_base</a></li><li class='child'><a href="../cookbook/http_api.html">Control and Monitoring through a HTTP API</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../deprecations/">Deprecated Behaviors</a></span><ul><li class='child'><a href="../deprecations/">Introduction</a></li><li class='child'><a href="../deprecations/backward_compatible_naming.html">Backward compatible naming</a></li><li class='child'><a href="../deprecations/update_properties.html">Introduction of the `update_properties` method</a></li></ul></li></ul>
                </nav>
            </div>
            <div class="col-md-9" role="main">
                <h1 class="no_toc" id="getting-started">Getting Started</h1>

<ul id="markdown-toc">
  <li><a href="#bundles-and-bundles-file-structure" id="markdown-toc-bundles-and-bundles-file-structure">Bundles and bundles' file structure</a></li>
  <li><a href="#robot-and-scene-description-using-sdf" id="markdown-toc-robot-and-scene-description-using-sdf">Robot and Scene description using SDF</a></li>
  <li><a href="#running-and-visualizing-a-gazebo-environment" id="markdown-toc-running-and-visualizing-a-gazebo-environment">Running and visualizing a Gazebo environment</a></li>
  <li><a href="#syskit_gazebo_configuration" id="markdown-toc-syskit_gazebo_configuration">Preparing the <code>gazebo</code> Syskit configuration</a></li>
</ul>

<p>We'll be getting right into the meat of things by creating a system's
integration package (a <code>bundle</code>), and setup a gazebo environment that will
allow us to continue with actually doing something with the system.</p>

<h2 id="bundles-and-bundles-file-structure">Bundles and bundles' file structure</h2>

<p>In Rock, the central place where the system design and integration happens is a
<em>bundle</em>. A bundle package is created in the <code>bundles/</code> folder of your Rock
workspace. For the time being, you can see bundles as a collection of
Syskit models (in <code>models/</code>), configuration files (in <code>config/</code>), SDF scenes
(<code>scenes/</code>) and SDF models (<code>models/sdf/</code>).</p>

<p>The following assumes that you have a <a href="installation.html">bootstrapped Rock
installation</a>, and that you have a terminal in which this
installation's <code>env.sh</code> file has been sourced.</p>

<p>Let's create a new bundle. In your Rock's workspace do</p>

<div class="highlight"><pre class="highlight plaintext"><code>acd
cd bundles
syskit gen app syskit_basics
cd syskit_basics
</code></pre></div>
<p>This creates a Roby application, Roby being the underlying application framework
and execution engine that Syskit is based on. In addition, it loads and sets up
Syskit in the applications <code>config/init.rb</code>.</p>

<p>We can now verify that the generated application loads with</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ syskit run
Bundles[INFO]: Active bundles: syskit_basics
default[INFO]: logs are in /home/doudou/dev/logs_area/syskit_basics/20170609-1609
default[INFO]: loaded Roby on ruby 2.3.1p112 (2016-04-26 revision 54768) [x86_64-linux]
default[INFO]: done initialization
default[INFO]: ready
</code></pre></div>
<p>Either hit CTRL+C, or run <code>syskit quit</code> in another terminal, to make it exit.</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ syskit quit
Bundles[INFO]: Active bundles: syskit_basics
default[INFO]: connected
default[INFO]: waiting for remote app to terminate
default[INFO]: closed communication
</code></pre></div>
<h2 id="robot-and-scene-description-using-sdf">Robot and Scene description using SDF</h2>

<p>The <a href="http://sdformat.org">Scene Description Format</a> is a XML format defined by the
Gazebo developers to describe both scenes and objects in these scenes (as e.g.
robots). We're going to learn how to leverage the information present in an SDF
file as possible, with the goal of having the SDF be the authoritative
information source for any information that can be represented in it.</p>

<p>But for now, let's get to create ourselves a scene with a robot in it. We
will <strong>not</strong> describe the SDF format in details, there's a lot of
Gazebo-related documentation about that, <a href="http://sdformat.org/spec">including a reference of the format
on sdformat.org</a></p>

<p>SDF scenes are made of <em>models</em>. Loosely-speaking, each model represents one
object in the scene. Moreover, models can be included in scenes through the
<code>&lt;include&gt;</code> tags, allowing to reuse models in different scenes. In general,
your robot should at least be described in a separate model to allow you to
reuse it in different simulation scenes.</p>

<p>For the purpose of this part of the documentation, we'll use Gazebo's UR10 arm
model as our robot. We however need to integrate it in another model so that
its base is fixed (using <a href="https://answers.gazebosim.org/question/5065/how-to-attach-arm-to-a-static-base-using-sdf/">this
method</a>).</p>

<p>Usually, the first scene one creates is an empty one, which later will give us
an environment in which to test basic functionality, without having to care
about collisions.</p>

<p>In the bundles, scenes are saved in <code>scenes/SCENE_NAME/SCENE_NAME.world</code>, e.g.
<code>scenes/empty_world/empty_world.world</code>:</p>

<div class="highlight"><pre class="highlight xml"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="nt">&lt;sdf</span> <span class="na">version=</span><span class="s">"1.6"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;world</span> <span class="na">name=</span><span class="s">"empty_world"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;model</span> <span class="na">name=</span><span class="s">"ur10_fixed"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;include&gt;</span>
                <span class="nt">&lt;name&gt;</span>ur10<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;uri&gt;</span>model://ur10<span class="nt">&lt;/uri&gt;</span>
            <span class="nt">&lt;/include&gt;</span>
            <span class="nt">&lt;joint</span> <span class="na">name=</span><span class="s">"attached_to_ground"</span> <span class="na">type=</span><span class="s">"fixed"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;parent&gt;</span>world<span class="nt">&lt;/parent&gt;</span>
                <span class="nt">&lt;child&gt;</span>ur10::base<span class="nt">&lt;/child&gt;</span>
            <span class="nt">&lt;/joint&gt;</span>
        <span class="nt">&lt;/model&gt;</span>
        <span class="nt">&lt;include&gt;</span>
            <span class="nt">&lt;uri&gt;</span>model://ground_plane<span class="nt">&lt;/uri&gt;</span>
        <span class="nt">&lt;/include&gt;</span>
    <span class="nt">&lt;/world&gt;</span>
<span class="nt">&lt;/sdf&gt;</span>
</code></pre></div>
<h2 id="running-and-visualizing-a-gazebo-environment">Running and visualizing a Gazebo environment</h2>

<p>Rock offers <code>vizkit3d</code>, its own 3D visualization environment. Since we will
definitely want to augment the visualization of the world with e.g. algorithm
feedback and/or sensor data, we'll be using this environment for the Gazebo
world as well, instead of using Gazebo's client.</p>

<p>The <code>rock-gazebo</code> tool starts a Vizkit3D visualization for the Gazebo scene.</p>

<div class="highlight"><pre class="highlight plaintext"><code>rock-gazebo empty_world
</code></pre></div>
<p>Starts both a Gazebo simulation and displays it:</p>

<p><img src="media/initial_rock_gazebo_viz.jpg" alt="Visualization of the simulation state with rock-gazebo-viz" class="fullwidth" /></p>

<div class="note">
  <p>The <code>ur10</code> and <code>ground_plane</code> models we are referencing in this world file need
to be downloaded from Gazebo's model repository. This is done automatically by
<code>rock-gazebo</code> the first time they're needed, but can also be done explicitly with
the <code>--download-only</code> option, e.g.</p>

<div class="highlight"><pre class="highlight plaintext"><code>rock-gazebo --download-only empty_world
</code></pre></div>
</div>

<h2 id="syskit_gazebo_configuration">Preparing the <code>gazebo</code> Syskit configuration</h2>

<p>Syskit configuration in bundles may be split into multiple configurations /
environments called "robots". A common organization is to create one bundle
per robot type or project, and create two robot configuration in it, one for
the simulation (<code>gazebo</code>) and one for the live system (<code>live</code>).</p>

<p>Let's create the <code>gazebo</code> configuration:</p>

<div class="highlight"><pre class="highlight plaintext"><code>$ syskit gen robot gazebo
Bundles[INFO]: Active bundles: syskit_basics
      exists  config/robots
      create  config/robots/gazebo.rb
</code></pre></div>
<p id="initial_setup">In order to setup Syskit to use the Gazebo instance, we first have to require
integration code and then load the environment. This is done by modifying the
newly-created <code>config/robots/gazebo.rb</code> configuration file to add:</p>

<div class="highlight"><pre class="highlight ruby"><code><span class="no">Robot</span><span class="p">.</span><span class="nf">init</span> <span class="k">do</span>
    <span class="no">Roby</span><span class="p">.</span><span class="nf">app</span><span class="p">.</span><span class="nf">register_app</span> <span class="s1">'../common_models'</span>
    <span class="nb">require</span> <span class="s1">'rock_gazebo/syskit'</span>
    <span class="no">Conf</span><span class="p">.</span><span class="nf">syskit</span><span class="p">.</span><span class="nf">transformer_enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="no">Robot</span><span class="p">.</span><span class="nf">requires</span> <span class="k">do</span>
    <span class="no">Syskit</span><span class="p">.</span><span class="nf">conf</span><span class="p">.</span><span class="nf">use_gazebo_world</span><span class="p">(</span><span class="s1">'empty_world'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div>
<p class="callout callout-info" id="syskit_r_option">Most Syskit commands accepts take a <code>-r</code> option followed by a name. This tells Syskit
which configuration file should be loaded within <code>config/robots/</code> <em>and only this</em>.
For instance, starting Syskit with the Gazebo configuration about is done with
<code>syskit run -rgazebo</code>.</p>

<p class="next-page"><strong>Next</strong>: now that we have a minimal scene and a working Gazebo installation, <a href="composition.html">let's do
something with it</a></p>

<div class="panel panel-warning">
  <div class="panel-heading">

    <p><a class="btn btn-warning" role="button" data-toggle="collapse" href="#under_the_hood" aria-expanded="false" aria-controls="under_the_hood">
  Advanced
</a><span class="advanced_description">Under the hood: how does the Rock/Gazebo bridge work</span></p>
  </div>
  <div class="collapse panel-body" id="under_the_hood">
    <p>Under the hood, the objects in the Gazebo instance are exposed to the Rock
system by means of <a href="http://gazebosim.org/tutorials?tut=system_plugin">a Gazebo system
plugin</a>. Each model, link,
sensor and some plugins are exposed this way. The plugin is implemented in the
<a href="https://github.com/rock-gazebo/simulation-rock_gazebo"><code>simulation/rock_gazebo</code> package</a>. The components
that implement this interface are implemented in the
<a href="https://github.com/rock-gazebo/simulation-orogen-rock_gazebo"><code>simulation/orogen/rock_gazebo</code> package</a>,
and are being run within the Gazebo process itself, synchronously with the
Gazebo simulation loop. The <code>rock-gazebo</code> and <code>rock-gzserver</code> tools are simple
shell wrappers around the <code>gazebo</code> and <code>gzserver</code> commands, but with the
addition of the system plugin.</p>

    <p>The task contexts in our scene can be visualized with rock-display:</p>

    <p><img src="media/rock_gazebo_task_contexts.jpg" alt="Components exported by a Gazebo instance under Rock" class="fullwidth" /></p>

    <p><code>rock-gazebo-viz</code> sets up the visualization to match the data in the SDF file and
then listen to pose updates from the <code>rock_gazebo::ModelTask</code> components exposed by the
Gazebo process. Given that this data is only output if the components are running,
<code>rock-gazebo-viz</code> starts them automatically. Use <code>--no-start</code> to avoid this.</p>
  </div>
</div>

            </div>
        </div>
    </div>

    <script>
    $('.docs-sidebar').affix({
        offset: {
            top: $('.docs-sidebar').offset().top
        }
    });
    </script>


        <footer class="container-fluid text-center">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Building Robots with Rock and Syskit</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/doudou" property="cc:attributionName" rel="cc:attributionURL">Sylvain Joyeux</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. Copyright Sylvain Joyeux and Contributors
        </footer>
    </body>
</html>
