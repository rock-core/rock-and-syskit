<!DOCTYPE html>
<html lang="en">
    <head>
        <meta content="IE=edge" http-equiv="X-UA-Compatible">
        <meta charset="utf-8">
        <meta content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Building Robots with Rock and Syskit</title>

        <link href="../images/favicon.ico" rel="icon" type="image/ico" relative="true" />
        <link href="../stylesheets/site.css" rel="stylesheet" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    </head>

    <body class="runtime_overview runtime_overview_event_loop">
            <!-- top navbar -->
    <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="myNavbar">
                <ul class="nav navbar-nav">
                    <li><a href="../">Home</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3" role="complementary">
                <nav class="docs-sidebar" data-spy="affix">
                    <ul class="nav"><li class='child'><a href="../">Building robots with Rock and Syskit</a></li><li class='parent'><span class='parent-label'><a href="../basics/">Basics</a></span><ul><li class='child'><a href="../basics/">Introduction</a></li><li class='child'><a href="../basics/installation.html">Installation</a></li><li class='child'><a href="../basics/day_to_day.html">Day-to-day Workspace Commands</a></li><li class='child'><a href="../basics/getting_started.html">Getting Started</a></li><li class='child'><a href="../basics/composition.html">Compositions</a></li><li class='child'><a href="../basics/constant_generator.html">Constant Generator</a></li><li class='child'><a href="../basics/devices.html">Profiles and Devices</a></li><li class='child'><a href="../basics/deployment.html">Deployment</a></li><li class='child'><a href="../basics/publishing.html">Publishing</a></li><li class='child'><a href="../basics/validation.html">Configuration Consistency</a></li><li class='child'><a href="../basics/recap.html">Recap</a></li></ul></li><li class='parent active'><span class='parent-label'><a href="./">Runtime Overview</a></span><ul><li class='child'><a href="./">Introduction</a></li><li class='child'><a href="task_structure.html">Task Structures</a></li><li class='child active'><a href="event_loop.html">Event Loop</a></li><li class='child'><a href="exceptions.html">Errors</a></li><li class='child'><a href="live_data.html">Live Data Visualization</a></li><li class='child'><a href="recap.html">Recap</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../workspace/">Workspace and Packages</a></span><ul><li class='child'><a href="../workspace/">Introduction</a></li><li class='child'><a href="../workspace/conventions.html">Conventions</a></li><li class='child'><a href="../workspace/setup.html">Starting a New Project</a></li><li class='child'><a href="../workspace/add_packages.html">Adding new packages</a></li><li class='child'><a href="../workspace/os_dependencies.html">OS Dependencies</a></li><li class='child'><a href="../workspace/global_configuration.html">Global Configuration</a></li><li class='child'><a href="../workspace/testing.html">Test Integration</a></li><li class='child'><a href="../workspace/managing.html">Build configuration design</a></li><li class='child'><a href="../workspace/troubleshooting.html">Troubleshooting</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../libraries/">Libraries</a></span><ul><li class='child'><a href="../libraries/">Introduction</a></li><li class='child'><a href="../libraries/add_packages.html">Add packages</a></li><li class='child'><a href="../libraries/cpp_libraries.html">C++ Library Packages</a></li><li class='child'><a href="../libraries/geometric_transformations.html">Geometric Transformations in C++ Libraries</a></li><li class='child'><a href="../libraries/ruby_libraries.html">Ruby Library Packages</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../components/">Components</a></span><ul><li class='child'><a href="../components/">Writing Components</a></li><li class='child'><a href="../components/orogen_packages.html">oroGen Packages</a></li><li class='child'><a href="../components/defining_types.html">Defining Types</a></li><li class='child'><a href="../components/importing_types.html">Importing Types</a></li><li class='child'><a href="../components/interface.html">Interface</a></li><li class='child'><a href="../components/state_machine.html">State Machine</a></li><li class='child'><a href="../components/writing_the_hooks.html">Writing the Hooks</a></li><li class='child'><a href="../components/timestamping.html">Timestamping</a></li><li class='child'><a href="../components/stream_aligner.html">Stream Aligner</a></li><li class='child'><a href="../components/geometric_transformations.html">Geometric Transformations</a></li><li class='child'><a href="../components/deployment.html">Deployments</a></li><li class='child'><a href="../components/runtime.html">Runtime</a></li><li class='child'><a href="../components/testing.html">Testing</a></li><li class='child'><a href="../components/types_in_ruby.html">Types in Ruby</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../component_networks/">Designing Component Networks</a></span><ul><li class='child'><a href="../component_networks/">Introduction</a></li><li class='child'><a href="../component_networks/composition.html">Compositions</a></li><li class='child'><a href="../component_networks/profiles.html">Profiles</a></li><li class='child'><a href="../component_networks/reusable_networks.html">Reusable Networks</a></li><li class='child'><a href="../component_networks/devices_and_busses.html">Robot definition&colon; Devices and Busses</a></li><li class='child'><a href="../component_networks/dynamic_services.html">Dynamic Services</a></li><li class='child'><a href="../component_networks/geometric_transformations.html">Geometric Transformations</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../coordination/">Coordination</a></span><ul><li class='child'><a href="../coordination/">Introduction</a></li><li class='child'><a href="../coordination/generalities.html">Generalities</a></li><li class='child'><a href="../coordination/tasks_and_events.html">Tasks and Events</a></li><li class='child'><a href="../coordination/action_methods.html">Action Methods</a></li><li class='child'><a href="../coordination/action_state_machines.html">Action State Machines</a></li><li class='child'><a href="../coordination/component_networks.html">Component Networks</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../simulation/">Simulation with Gazebo</a></span><ul><li class='child'><a href="../simulation/">Introduction</a></li><li class='child'><a href="../simulation/models_links_and_joints.html">Models, Links, Joints and Sensors</a></li><li class='child'><a href="../simulation/plugins.html">Plugins</a></li><li class='child'><a href="../simulation/transformer.html">Transformer</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../syskit_error_handling/">Error Handling</a></span><ul><li class='child'><a href="../syskit_error_handling/">Introduction</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../log_management/">Log Management</a></span><ul><li class='child'><a href="../log_management/">Introduction</a></li><li class='child'><a href="../log_management/runtime.html">Log Generation at Runtime</a></li><li class='child'><a href="../log_management/datastore.html">Storing Logs</a></li><li class='child'><a href="../log_management/jupyter.html">Log Analysis with Jupyter</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../testing/">Testing and Debugging</a></span><ul><li class='child'><a href="../testing/">Introduction</a></li><li class='child'><a href="../testing/component.html">Component Tests</a></li><li class='child'><a href="../testing/integration.html">Integration Tests</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../cookbook/">Cookbook</a></span><ul><li class='child'><a href="../cookbook/">Introduction</a></li><li class='child'><a href="../cookbook/device_drivers.html">Device Drivers with iodrivers_base</a></li><li class='child'><a href="../cookbook/http_api.html">Control and Monitoring through a HTTP API</a></li></ul></li><li class='parent'><span class='parent-label'><a href="../deprecations/">Deprecated Behaviors</a></span><ul><li class='child'><a href="../deprecations/">Introduction</a></li><li class='child'><a href="../deprecations/backward_compatible_naming.html">Backward compatible naming</a></li><li class='child'><a href="../deprecations/update_properties.html">Introduction of the `update_properties` method</a></li></ul></li></ul>
                </nav>
            </div>
            <div class="col-md-9" role="main">
                <h1 class="no_toc" id="syskits-event-loop">Syskit's event loop</h1>

<ul id="markdown-toc">
  <li><a href="#events-reactor-synchronous-and-asynchronous" id="markdown-toc-events-reactor-synchronous-and-asynchronous">Events, Reactor, Synchronous and Asynchronous</a></li>
  <li><a href="#scheduling" id="markdown-toc-scheduling">Scheduling</a></li>
  <li><a href="#component-lifecycle-configuration-startup-and-shutdown" id="markdown-toc-component-lifecycle-configuration-startup-and-shutdown">Component Lifecycle, Configuration, Startup and Shutdown</a></li>
  <li><a href="#garbage_collection" id="markdown-toc-garbage_collection">Garbage Collection</a></li>
  <li><a href="#reconfiguration" id="markdown-toc-reconfiguration">Component Reconfiguration</a></li>
</ul>

<p>This page will be the first one that will go deeper in Syskit's execution
model. This one will present Syskit's event loop structure, detailing how
things like configuring, starting or stopping components is sequenced
during Syskit's execution.</p>

<h2 id="events-reactor-synchronous-and-asynchronous">Events, Reactor, Synchronous and Asynchronous</h2>

<p>Fundamentally, Syskit's execution is event-based and based on the reactor
pattern. External events are received and Syskit does "other things" in
reaction to their happening. Most common reaction is to call a piece of code
registered as a <em>handler</em> for the event. Schematically:</p>

<p><img src="media/event_loop.svg" alt="Schematic representation of the event loop logic" class="fullwidth" /></p>

<p>Unlike common event-based programming environments, Syskit does not only
<em>react</em> to events, but can also <em>cause</em> them. Some events, such as the start
and stop events of components are <em>controllable</em>, which means that Syskit can
make them happen instead of only waiting for them to happen, by calling a piece
of code called the <em>event command</em>.</p>

<p>Within Syskit, events are <em>propagated</em>. This means that Syskit tries to
maintain a synchronous model in which within the same propagation, events can
cause the emission of other events (within for instance an event handler). The
new events are then propagated which …. For instance, compositions do not have
to do anything to "be started". Therefore, the <em>start</em> event is emitted at the
moment it is called. This propagation is <strong>synchronous</strong>, the whole propagation
is done within a single event cycle.</p>

<p>This event propagation is done <strong>within a single thread</strong>. Which means that
computation within event commands and handlers will block the propagation. To
avoid issues with e.g. blocking network calls, Syskit has infrastructure to
execute remote calls <strong>asynchronously</strong>. The event command executes in a
separate (blocking) thread and the event emission is delayed until that command
finishes, possibly in a new event cycle.</p>

<h2 id="scheduling">Scheduling</h2>

<p>The scheduler is an object responsible to determine which <em>start</em> commands can
be executed at the beginning of a given cycle, and to execute them. Syskit's
default scheduler is the temporal scheduler. We will see some characteristic of
this scheduler in this section.</p>

<p>First and foremost, a component can be scheduled only if:</p>

<ul>
  <li>
    <p>it has all its parameters set. This is a common problem, that some arguments
are unset and the network does not run. This can be caught <a href="../basics/constant_generator.html#missing_arguments">in
tests</a>. At
runtime, in the IDE, this is leads to the <code>partially instanciated</code> message:</p>

    <p><img src="media/missing_arguments.jpg" alt="Partially instantiated network in the IDE" class="fullwidth" /></p>
  </li>
  <li>
    <p>its <a href="task_structure.html#execution_agents">execution agent</a> is ready. Agents
are expected to have a <em>ready</em> event that is emitted when the agent reached a
state where the components it supports can be executed.</p>
  </li>
</ul>

<p>In addition, the basic scheduling rules are:</p>

<ul>
  <li>a component may be started only if at least one of its parents <a href="task_structure.html#dependency">in the
dependency relation</a> is running (the <em>start</em>
event has been emitted).</li>
  <li>a component may be started only if all its inputs are connected</li>
</ul>

<p>To illustrate this, let's have again a look at the startup "from scratch" of
the safe pose job. Each image represents one execution cycle. An empty circle
is an event command and full circle an event emission. See how the compositions
are both called (scheduled) and emitted in the same cycle while the components
<em>start</em> event are emitted in a different cycle than the one they have been
called in. Finally, the cycle where seemingly nothing happens is due to the
component configuration, which is not represented by an event.</p>

<div id="job_start_step_by_step" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#job_start_step_by_step" data-slide-to="0" class="active"></li>
    <li data-target="#job_start_step_by_step" data-slide-to="1"></li>
    <li data-target="#job_start_step_by_step" data-slide-to="2"></li>
    <li data-target="#job_start_step_by_step" data-slide-to="3"></li>
    <li data-target="#job_start_step_by_step" data-slide-to="4"></li>
    <li data-target="#job_start_step_by_step" data-slide-to="5"></li>
    <li data-target="#job_start_step_by_step" data-slide-to="6"></li>
    <li data-target="#job_start_step_by_step" data-slide-to="7"></li>
    <li data-target="#job_start_step_by_step" data-slide-to="8"></li>
    <li data-target="#job_start_step_by_step" data-slide-to="9"></li>
  </ol>

  <!-- Wrapper for slides -->
  <div class="carousel-inner" role="listbox">
    <div class="item active"><img src="media/scheduling_1.png" alt="start of the execution agents" /></div>
    <div class="item"><img src="media/scheduling_2.png" alt="RubyTask ready" /></div>
    <div class="item"><img src="media/scheduling_3.png" alt="Gazebo ready" /></div>
    <div class="item"><img src="media/scheduling_4.png" alt="start JointPositionGenerator" /></div>
    <div class="item"><img src="media/scheduling_5.png" alt="Wait" /></div>
    <div class="item"><img src="media/scheduling_6.png" alt="JointPositionGenerator started" /></div>
    <div class="item"><img src="media/scheduling_7.png" alt="Wait" /></div>
    <div class="item"><img src="media/scheduling_8.png" alt="start ModelTask" /></div>
    <div class="item"><img src="media/scheduling_9.png" alt="ModelTask running" /></div>
  </div>

  <!-- Controls -->
  <a class="left carousel-control" href="#job_start_step_by_step" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#job_start_step_by_step" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
    <span class="sr-only">Next</span>
  </a>
</div>

<p class="callout callout-warning">Under these rules, the semantic of "a component is running" is to represent
that the system has  the <em>intent</em> to achieve its role, but not that it actually
does execute that role (yet): the component's children may not run yet. For
instance, a running safe position composition represents that the system has
the intent to reach that position, but it will not be reaching that position
until the composition's constant generator and arm model are running. This will
be an important distinction when building more complex, coordinated systems.</p>

<p class="callout callout-info">Note that this is a simplification that is "good enough" for now. These are
default rules, that can be overridden explicitly on a case-by-case basis. There
will be more about this in <a href="../coordination/">the coordination part</a>.</p>

<h2 id="component-lifecycle-configuration-startup-and-shutdown">Component Lifecycle, Configuration, Startup and Shutdown</h2>

<p>Rock components have a lifecycle of their own. This lifecyle is what makes a
generic coordination of them possible: it is possible to expect a standardized
behavior. The nominal lifecycle - that is, without error states - is the
following state machine:</p>

<p><img src="media/state_machine.svg" alt="Nominal component state machine" class="fullwidth" /></p>

<p>This is the lifecycle of a single component. Sequencing of the startup and
shutdown of a network is more complicated. Syskit relies on some assumptions
to make it possible:</p>

<ol>
  <li>Component's <code>configure</code> transition is expected to be standalone - i.e. not
rely on other components. The exception to this rule are devices that rely
on data bus components (e.g. a CAN device on a CAN bus). We will see those
in the advanced coordination section.</li>
  <li>Components have the ability to create new ports dynamically, which is
usually controlled by their configuration. Syskit may therefore not expect
all ports to be available before the component is configured. However,
Syskit restricts dynamic port creation to <code>configure</code>, and expects them
to be destroyed during <code>cleanup</code>.</li>
</ol>

<p>With these assumptions, Syskit can generically sequence the startup and
shutdown of a component network:</p>

<ul>
  <li>create new connections between non-dynamic ports that involve at least one
component that is not configured. Connections are parallelized. <em>Rationale:
the "components not configured" constraint ensures that we do not disrupt
existing components before the rest of the network is ready to run</em>.</li>
  <li>configure components in parallel. <em>Rationale: the component configurations
are standalone</em>.</li>
  <li>apply the remaining connection modifications (addition and removal, in parallel)</li>
  <li>start components (in parallel)</li>
</ul>

<p>Components are stopped through Syskit's garbage collection mechanism. Connections
are garbage collected when the corresponding component(s) are.</p>

<p>All actions that involve a direct interaction with the component (sending the
start command, writing properties, …) are done asynchronously in separate
threads, and will be done in parallel if more than one component are being
setup. All actions that involve code written within the Syskit app itself are
executed sequentially within the main thread.</p>

<h2 id="garbage_collection">Garbage Collection</h2>

<p>The garbage collection recursively stops tasks that are not useful for an
active job, as in the following video. Note again that the compositions' stop
events are emitted in the same cycle as they are commanded, while components
are stopped asynchronously:</p>

<div id="garbage_collection_step_by_step" class="carousel slide" data-ride="carousel">
  <!-- Indicators -->
  <ol class="carousel-indicators">
    <li data-target="#garbage_collection_step_by_step" data-slide-to="0" class="active"></li>
    <li data-target="#garbage_collection_step_by_step" data-slide-to="1"></li>
  </ol>

  <!-- Wrapper for slides -->
  <div class="carousel-inner" role="listbox">
    <div class="item active"><img src="media/gc_1.png" alt="composition stops and components are commanded to stop" /></div>
    <div class="item"><img src="media/gc_2.png" alt="all components stopped" /></div>
  </div>

  <!-- Controls -->
  <a class="left carousel-control" href="#garbage_collection_step_by_step" role="button" data-slide="prev">
    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="right carousel-control" href="#garbage_collection_step_by_step" role="button" data-slide="next">
    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
    <span class="sr-only">Next</span>
  </a>
</div>

<h2 id="reconfiguration">Component Reconfiguration</h2>

<p>As <a href="task_structure.html#usefulness">already mentioned</a>, external processes are
marked as permanent by default within Syskit. One of the main reasons is that
configuration of an external component may be fairly expensive (load maps,
precompute expensive data structures, configure a device, …), and Syskit
therefore attempts to reduce how often they are required.</p>

<p>When configuring components, Syskit will attempt to <code>cleanup</code> and <code>configure</code> a
given component only if the component's configuration changed since the last
configuration. Otherwise, it will only have to start it. <code>cleanup</code> is also done
asynchronously to avoid blocking the main thread execution.</p>

<p>In the following video, we change the configuration file for our cartesian
controller, reload the configuration and trigger a reconfiguration.</p>

<p class="note"><strong>Note</strong> the "reload" step only loads the modified files from the disk into the
Syskit process. The "reconfigure" step will change configuration on already
running tasks.</p>

<div class="fluid-video">
  <iframe width="853" height="480" src="https://www.youtube.com/embed/zqvzdHg6wfg?rel=0&amp;showinfo=0" frameborder="0" allowfullscreen=""></iframe>
</div>

<p>Another source of reconfiguration is to transition between two networks that
select different component configurations. When this happens, Syskit will stop
and reconfigure the affected components while deploying the new network.</p>

<p class="next-page"><strong>Next</strong>: let's see <a href="exceptions.html">how Syskit reacts when things go
wrong</a></p>

            </div>
        </div>
    </div>

    <script>
    $('.docs-sidebar').affix({
        offset: {
            top: $('.docs-sidebar').offset().top
        }
    });
    </script>


        <footer class="container-fluid text-center">
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/InteractiveResource" property="dct:title" rel="dct:type">Building Robots with Rock and Syskit</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/doudou" property="cc:attributionName" rel="cc:attributionURL">Sylvain Joyeux</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. Copyright Sylvain Joyeux and Contributors
        </footer>
    </body>
</html>
